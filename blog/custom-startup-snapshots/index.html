<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Custom startup snapshots · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="V8 embedders can utilize snapshots to skip over the startup time incurred by initializations of JavaScript programs." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Custom startup snapshots</h1><p class=meta>发布时间 <time datetime="2015-09-25 13:33:37" itemprop=datePublished title="2015-09-25 13:33:37">2015-09-25</time> · 标签： <a href=/blog/tags/internals/ class=tag>internals</a></header><div itemprop=articleBody><p>The JavaScript specification includes a lot of built-in functionality, from <a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Math>math functions</a> to a <a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Guide/Regular_Expressions>full-featured regular expression engine</a>. Every newly-created V8 context has these functions available from the start. For this to work, the global object (for example, the window object in a browser) and all the built-in functionality must be set up and initialized into V8’s heap at the time the context is created. It takes quite some time to do this from scratch.<p>Fortunately, V8 uses a shortcut to speed things up: just like thawing a frozen pizza for a quick dinner, we deserialize a previously-prepared snapshot directly into the heap to get an initialized context. On a regular desktop computer, this can bring the time to create a context from 40 ms down to less than 2 ms. On an average mobile phone, this could mean a difference between 270 ms and 10 ms.<p>Applications other than Chrome that embed V8 may require more than vanilla Javascript. Many load additional library scripts at startup, before the “actual” application runs. For example, a simple TypeScript VM based on V8 would have to load the TypeScript compiler on startup in order to translate TypeScript source code into JavaScript on-the-fly.<p>As of the release of V8 v4.3 two months ago, embedders can utilize snapshotting to skip over the startup time incurred by such an initialization. The <a href=https://chromium.googlesource.com/v8/v8.git/+/4.5.103.9/test/cctest/test-serialize.cc#661>test case</a> for this feature shows how this API works.<p>To create a snapshot, we can call <code>v8::V8::CreateSnapshotDataBlob</code> with the to-be-embedded script as a null-terminated C string. After creating a new context, this script is compiled and executed. In our example, we create two custom startup snapshots, each of which define functions on top of what JavaScript already has built in.<p>We can then use <code>v8::Isolate::CreateParams</code> to configure a newly-created isolate so that it initializes contexts from a custom startup snapshot. Contexts created in that isolate are exact copies of the one from which we took a snapshot. The functions defined in the snapshot are available without having to define them again.<p>There is an important limitation to this: the snapshot can only capture V8’s heap. Any interaction from V8 with the outside is off-limits when creating the snapshot. Such interactions include:<ul><li>defining and calling API callbacks (i.e. functions created via <code>v8::FunctionTemplate</code>)<li>creating typed arrays, since the backing store may be allocated outside of V8</ul><p>And of course, values derived from sources such as <code>Math.random</code> or <code>Date.now</code> are fixed once the snapshot has been captured. They are no longer really random nor reflect the current time.<p>Limitations aside, startup snapshots remain a great way to save time on initialization. We can shave off 100 ms from the startup spent on loading the TypeScript compiler in our example above (on a regular desktop computer). We're looking forward to seeing how you might put custom snapshots to use!</div><footer><div><picture><source srcset="/_img/avatars/yang-guo.avif, /_img/avatars/yang-guo@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/yang-guo.jpg srcset="/_img/avatars/yang-guo@2x.jpg 2x" width=96></picture><p>作者：Yang Guo (<a href=https://twitter.com/hashseed>@hashseed</a>), Software Engineer and engine pre-heater supplier.</div></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/custom-startup-snapshots>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/custom-startup-snapshots.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>