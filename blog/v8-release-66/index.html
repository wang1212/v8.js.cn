<!doctype html><html lang=zh-CN><meta charset=utf-8><title>V8 release v6.6 · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="V8 v6.6 includes optional catch binding, extended string trimming, several parse/compile/runtime performance improvements, and much more!" name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>V8 release v6.6</h1><p class=meta>发布时间 <time datetime="2018-03-27 13:33:37" itemprop=datePublished title="2018-03-27 13:33:37">2018-03-27</time> · 标签： <a href=/blog/tags/release/ class=tag>release</a></header><div itemprop=articleBody><p>Every six weeks, we create a new branch of V8 as part of our <a href=/docs/release-process>release process</a>. Each version is branched from V8’s Git master immediately before a Chrome Beta milestone. Today we’re pleased to announce our newest branch, <a href=https://chromium.googlesource.com/v8/v8.git/+log/branch-heads/6.6>V8 version 6.6</a>, which is in beta until its release in coordination with Chrome 66 Stable in several weeks. V8 v6.6 is filled with all sorts of developer-facing goodies. This post provides a preview of some of the highlights in anticipation of the release.<h2 id=javascript-language-features>JavaScript language features <a href=#javascript-language-features class=bookmark>#</a></h2><h3 id=function-tostring><code>Function.prototype.toString</code> revision <a href=#function-tostring class=bookmark>#</a></h3><p><a href=/features/function-tostring><code>Function.prototype.toString()</code></a> now returns exact slices of source code text, including whitespace and comments. Here’s an example comparing the old and the new behavior:<pre class=language-js><code class=language-js><span class="token comment">// Note the comment between the `function` keyword</span><br><span class="token comment">// and the function name, as well as the space following</span><br><span class="token comment">// the function name.</span><br><span class="token keyword">function</span> <span class="token comment">/* a comment */</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br><span class="token comment">// Previously:</span><br>foo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → 'function foo() {}'</span><br><span class="token comment">//             ^ no comment</span><br><span class="token comment">//                ^ no space</span><br><br><span class="token comment">// Now:</span><br>foo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → 'function /* comment */ foo () {}'</span></code></pre><h3 id=json-ecmascript>JSON ⊂ ECMAScript <a href=#json-ecmascript class=bookmark>#</a></h3><p>Line separator (U+2028) and paragraph separator (U+2029) symbols are now allowed in string literals, <a href=/features/subsume-json>matching JSON</a>. Previously, these symbols were treated as line terminators within string literals, and so using them resulted in a <code>SyntaxError</code> exception.<h3 id=optional-catch-binding>Optional <code>catch</code> binding <a href=#optional-catch-binding class=bookmark>#</a></h3><p>The <code>catch</code> clause of <code>try</code> statements can now be <a href=/features/optional-catch-binding>used without a parameter</a>. This is useful if you don’t have a need for the <code>exception</code> object in the code that handles the exception.<pre class=language-js><code class=language-js><span class="token keyword">try</span> <span class="token punctuation">{</span><br>  <span class="token function">doSomethingThatMightThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span> <span class="token comment">// → Look mom, no binding!</span><br>  <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h3 id=string-trimming>One-sided string trimming <a href=#string-trimming class=bookmark>#</a></h3><p>In addition to <code>String.prototype.trim()</code>, V8 now implements <a href=/features/string-trimming><code>String.prototype.trimStart()</code> and <code>String.prototype.trimEnd()</code></a>. This functionality was previously available through the non-standard <code>trimLeft()</code> and <code>trimRight()</code> methods, which remain as aliases of the new methods for backward compatibility.<pre class=language-js><code class=language-js><span class="token keyword">const</span> string <span class="token operator">=</span> <span class="token string">'  hello world  '</span><span class="token punctuation">;</span><br>string<span class="token punctuation">.</span><span class="token function">trimStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → 'hello world  '</span><br>string<span class="token punctuation">.</span><span class="token function">trimEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → '  hello world'</span><br>string<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → 'hello world'</span></code></pre><h3 id=array-values><code>Array.prototype.values</code> <a href=#array-values class=bookmark>#</a></h3><p><a href=https://tc39.es/ecma262/#sec-array.prototype.values>The <code>Array.prototype.values()</code> method</a> gives arrays the same iteration interface as the ES2015 <code>Map</code> and <code>Set</code> collections: all can now be iterated over by <code>keys</code>, <code>values</code>, or <code>entries</code> by calling the same-named method. This change has the potential to be incompatible with existing JavaScript code. If you discover odd or broken behavior on a website, please try to disable this feature via <code>chrome://flags/#enable-array-prototype-values</code> and <a href="https://bugs.chromium.org/p/v8/issues/entry?template=Defect+report+from+user">file an issue</a>.<h2 id=code-caching-after-execution>Code caching after execution <a href=#code-caching-after-execution class=bookmark>#</a></h2><p>The terms <em>cold</em> and <em>warm load</em> might be well-known for people concerned about loading performance. In V8, there is also the concept of a <em>hot load</em>. Let’s explain the different levels with Chrome embedding V8 as an example:<ul><li><strong>Cold load:</strong> Chrome sees the visited web page for the first time and does not have any data cached at all.<li><strong>Warm load</strong>: Chrome remembers that the web page was already visited and can retrieve certain assets (e.g. images and script source files) from the cache. V8 recognizes that the page shipped the same script file already, and therefore caches the compiled code along with the script file in the disk cache.<li><strong>Hot load</strong>: The third time Chrome visits the web page, when serving script file from the disk cache, it also provides V8 with the code cached during the previous load. V8 can use this cached code to avoid having to parse and compile the script from scratch.</ul><p>Before V8 v6.6 we cached the generated code immediately after the top-level compile. V8 only compiles the functions that are known to be immediately executed during the top-level compile and marks other functions for lazy compilation. This meant that cached code only included top-level code, while all other functions had to be lazily compiled from scratch on each page load. Beginning with version 6.6, V8 caches the code generated after the script’s top-level execution. As we execute the script, more functions are lazily compiled and can be included in the cache. As a result, these functions don’t need to be compiled on future page loads, reducing compile and parse time in hot load scenarios by between 20–60%. The visible user change is a less congested main thread, thus a smoother and faster loading experience.<p>Look out for a detailed blog post on this topic soon.<h2 id=background-compilation>Background compilation <a href=#background-compilation class=bookmark>#</a></h2><p>For some time V8 has been able to <a href=https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html>parse JavaScript code on a background thread</a>. With V8’s new <a href=/blog/launching-ignition-and-turbofan>Ignition bytecode interpreter that shipped last year</a>, we were able to extend this support to also enable compilation of the JavaScript source to bytecode on a background thread. This enables embedders to perform more work off the main thread, freeing it up to execute more JavaScript and reduce jank. We enabled this feature in Chrome 66, where we see between 5% to 20% reduction on main-thread compilation time on typical websites. For more details, please see <a href=/blog/background-compilation>the recent blog post on this feature</a>.<h2 id=removal-of-ast-numbering>Removal of AST numbering <a href=#removal-of-ast-numbering class=bookmark>#</a></h2><p>We have continued to reap benefits from simplifying our compilation pipeline after the <a href=/blog/launching-ignition-and-turbofan>Ignition and TurboFan launch last year</a>. Our previous pipeline required a post-parsing stage called "AST Numbering", where nodes in the generated abstract syntax tree were numbered so that the various compilers using it would have a common point of reference.<p>Over time this post-processing pass had ballooned to include other functionality: numbering suspend point for generators and async functions, collecting inner functions for eager compilation, initializing literals or detecting unoptimizable code patterns.<p>With the new pipeline, the Ignition bytecode became the common point of reference, and the numbering itself was no longer required — but, the remaining functionality was still needed, and the AST numbering pass remained.<p>In V8 v6.6, we finally managed to <a href="https://bugs.chromium.org/p/v8/issues/detail?id=7178">move out or deprecate this remaining functionality</a> into other passes, allowing us to remove this tree walk. This resulted in a 3-5% improvement in real-world compile time.<h2 id=asynchronous-performance-improvements>Asynchronous performance improvements <a href=#asynchronous-performance-improvements class=bookmark>#</a></h2><p>We managed to squeeze out some nice performance improvements for promises and async functions, and especially managed to close the gap between async functions and desugared promise chains.<figure><img alt="" height=457 loading=lazy src=/_img/v8-release-66/promise.svg width=754><figcaption>Promise performance improvements</figcaption></figure><p>In addition, the performance of async generators and async iteration was improved significantly, making them a viable option for the upcoming Node 10 LTS, which is scheduled to include V8 v6.6. As an example, consider the following Fibonacci sequence implementation:<pre class=language-js><code class=language-js><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">fibonacciSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">yield</span> a<span class="token punctuation">;</span><br>    <span class="token keyword">const</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><br>    a <span class="token operator">=</span> b<span class="token punctuation">;</span><br>    b <span class="token operator">=</span> c<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> value <span class="token keyword">of</span> <span class="token function">fibonacciSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">--</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>We’ve measured the following improvements for this pattern, before and after Babel transpilation:<figure><img alt="" height=483 loading=lazy src=/_img/v8-release-66/async-generator.svg width=767><figcaption>Async generator performance improvements</figcaption></figure><p>Finally, <a href=https://chromium-review.googlesource.com/c/v8/v8/+/866734>bytecode improvements</a> to “suspendable functions” such as generators, async functions, and modules, have improved the performance of these functions while running in the interpreter, and decreased their compiled size. We’re planning on improving the performance of async functions and async generators even further with upcoming releases, so stay tuned.<h2 id=array-performance-improvements>Array performance improvements <a href=#array-performance-improvements class=bookmark>#</a></h2><p>The throughput performance of <code>Array#reduce</code> was increased by more than 10× for holey double arrays (<a href=/blog/elements-kinds>see our blog post for an explanation what holey and packed arrays are</a>). This widens the fast-path for cases where <code>Array#reduce</code> is applied to holey and packed double arrays.<figure><img alt="" height=371 loading=lazy src=/_img/v8-release-66/array-reduce.svg width=650><figcaption><code>Array.prototype.reduce</code> performance improvements</figcaption></figure><h2 id=untrusted-code-mitigations>Untrusted code mitigations <a href=#untrusted-code-mitigations class=bookmark>#</a></h2><p>In V8 v6.6 we’ve landed <a href=/docs/untrusted-code-mitigations>more mitigations for side-channel vulnerabilities</a> to prevent information leaks to untrusted JavaScript and WebAssembly code.<h2 id=gyp-is-gone>GYP is gone <a href=#gyp-is-gone class=bookmark>#</a></h2><p>This is the first V8 version that officially ships without GYP files. If your product needs the deleted GYP files, you need to copy them into your own source repository.<h2 id=memory-profiling>Memory profiling <a href=#memory-profiling class=bookmark>#</a></h2><p>Chrome’s DevTools can now trace and snapshot C++ DOM objects and display all reachable DOM objects from JavaScript with their references. This feature is one of the benefits of the new C++ tracing mechanism of the V8 garbage collector. For more information please have a look at <a href=/blog/tracing-js-dom>the dedicated blog post</a>.<h2 id=v8-api>V8 API <a href=#v8-api class=bookmark>#</a></h2><p>Please use <code>git log branch-heads/6.5..branch-heads/6.6 include/v8.h</code> to get a list of the API changes.<p>Developers with an <a href=/docs/source-code#using-git>active V8 checkout</a> can use <code>git checkout -b 6.6 -t branch-heads/6.6</code> to experiment with the new features in V8 v6.6. Alternatively you can <a href=https://www.google.com/chrome/browser/beta.html>subscribe to Chrome’s Beta channel</a> and try the new features out yourself soon.</div><footer><div><p>作者：the V8 team.</div><a href=https://twitter.com/v8js/status/978534399938584576 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/v8-release-66>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/v8-release-66.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>