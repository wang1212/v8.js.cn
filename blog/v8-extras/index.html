<!doctype html><html lang=zh-CN><meta charset=utf-8><title>V8 extras · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="V8 v4.8 includes “V8 extras”, a simple interface designed with the goal of allowing embedders to write high-performance, self-hosted APIs." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>V8 extras</h1><p class=meta>发布时间 <time datetime="2016-02-04 13:33:37" itemprop=datePublished title="2016-02-04 13:33:37">2016-02-04</time> · 标签： <a href=/blog/tags/internals/ class=tag>internals</a></header><div itemprop=articleBody><p>V8 implements a large subset of the JavaScript language’s built-in objects and functions in JavaScript itself. For example, you can see our <a href=https://code.google.com/p/chromium/codesearch#chromium/src/v8/src/js/promise.js>promises implementation</a> is written in JavaScript. Such built-ins are called <em>self-hosted</em>. These implementations are included in our <a href=/blog/custom-startup-snapshots>startup snapshot</a> so that new contexts can be quickly created without needing to setup and initialize the self-hosted built-ins at runtime.<p>Embedders of V8, such as Chromium, sometimes desire to write APIs in JavaScript too. This works especially well for platform features that are self-contained, like <a href=https://streams.spec.whatwg.org/ >streams</a>, or for features that are part of a “layered platform” of higher-level capabilities built on top of pre-existing lower-level ones. Although it’s always possible to run extra code at startup time to bootstrap embedder APIs (as is done in Node.js, for example), ideally embedders should be able to get the same speed benefits for their self-hosted APIs that V8 does.<p>V8 extras are a new feature of V8, as of our <a href=/blog/v8-release-48>v4.8 release</a>, designed with the goal of allowing embedders to write high-performance, self-hosted APIs via a simple interface. Extras are embedder-provided JavaScript files which are compiled directly into the V8 snapshot. They also have access to a few helper utilities that make it easier to write secure APIs in JavaScript.<h2 id=an-example>An example <a href=#an-example class=bookmark>#</a></h2><p>A V8 extra file is simply a JavaScript file with a certain structure:<pre class=language-js><code class=language-js><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> v8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token string">'use strict'</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> Object <span class="token operator">=</span> global<span class="token punctuation">.</span>Object<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> x <span class="token operator">=</span> v8<span class="token punctuation">.</span><span class="token function">createPrivateSymbol</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> y <span class="token operator">=</span> v8<span class="token punctuation">.</span><span class="token function">createPrivateSymbol</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">class</span> <span class="token class-name">Vec2</span> <span class="token punctuation">{</span><br>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">theX<span class="token punctuation">,</span> theY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">this</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> theX<span class="token punctuation">;</span><br>      <span class="token keyword">this</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> theY<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> binding<span class="token punctuation">.</span><span class="token function">computeNorm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> <span class="token string">'Vec2'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    value<span class="token operator">:</span> Vec2<span class="token punctuation">,</span><br>    enumerable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>    writable<span class="token operator">:</span> <span class="token boolean">true</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  binding<span class="token punctuation">.</span>Vec2 <span class="token operator">=</span> Vec2<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>There are a few things to notice here:<ul><li>The <code>global</code> object is not present in the scope chain, so any access to it (such as that for <code>Object</code>) has to be done explicitly through the provided <code>global</code> argument.<li>The <code>binding</code> object is a place to store values for or retrieve values from the embedder. A C++ API <code>v8::Context::GetExtrasBindingObject()</code> provides access to the <code>binding</code> object from the embedder’s side. In our toy example, we let the embedder perform norm computation; in a real example you might delegate to the embedder for something trickier like URL resolution. We also add the <code>Vec2</code> constructor to the <code>binding</code> object, so that embedder code can create <code>Vec2</code> instances without going through the potentially-mutable <code>global</code> object.<li>The <code>v8</code> object provides a small number of APIs to allow you to write secure code. Here we create private symbols to store our internal state in a way that cannot be manipulated from the outside. (Private symbols are a V8-internal concept and do not make sense in standard JavaScript code.) V8’s built-ins often use “%-function calls” for these sort of things, but V8 extras cannot use %-functions since they are an internal implementation detail of V8 and not suitable for embedders to depend on.</ul><p>You might be curious about where these objects come from. All three of them are initialized in <a href=https://code.google.com/p/chromium/codesearch#chromium/src/v8/src/bootstrapper.cc>V8’s bootstrapper</a>, which installs some basic properties but mostly leaves the initialization to V8’s self-hosted JavaScript. For example, almost every .js file in V8 installs something on <code>global</code>; see e.g. <a href="https://code.google.com/p/chromium/codesearch#chromium/src/v8/src/js/promise.js&sq=package:chromium&l=439">promise.js</a> or <a href="https://code.google.com/p/chromium/codesearch#chromium/src/v8/src/js/uri.js&sq=package:chromium&l=371">uri.js</a>. And we install APIs onto the <code>v8</code> object in <a href="https://code.google.com/p/chromium/codesearch#search/&q=extrasUtils&sq=package:chromium&type=cs">a number of places</a>. (The <code>binding</code> object is empty until manipulated by an extra or embedder, so the only relevant code in V8 itself is when the bootstrapper creates it.)<p>Finally, to tell V8 that we’ll be compiling in an extra, we add a line to our project’s gypfile:<pre class=language-js><code class=language-js><span class="token string">'v8_extra_library_files'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./Vec2.js'</span><span class="token punctuation">]</span></code></pre><p>(You can see a real-world example of this <a href="https://code.google.com/p/chromium/codesearch#chromium/src/v8/build/standalone.gypi&sq=package:chromium&type=cs&l=170">in V8’s gypfile</a>.)<h2 id=v8-extras-in-practice>V8 extras in practice <a href=#v8-extras-in-practice class=bookmark>#</a></h2><p>V8 extras provide a new and lightweight way for embedders to implement features. JavaScript code can more easily manipulate JavaScript built-ins like arrays, maps, or promises; it can call other JavaScript functions without ceremony; and it can deal with exceptions in an idiomatic way. Unlike C++ implementations, features implemented in JavaScript via V8 extras can benefit from inlining, and calling them does not incur any boundary-crossing costs. These benefits are especially pronounced when compared to a traditional bindings system like Chromium’s Web IDL bindings.<p>V8 extras were introduced and refined over the last year, and Chromium is currently using them to <a href=https://code.google.com/p/chromium/codesearch#chromium/src/third_party/WebKit/Source/core/streams/ReadableStream.js>implement streams</a>. Chromium is also considering V8 extras for implementing <a href=https://codereview.chromium.org/1333323003>scroll customization</a> and <a href=https://groups.google.com/a/chromium.org/d/msg/blink-dev/V_bJNtOg0oM/VKbbYs-aAgAJ>efficient geometry APIs</a>.<p>V8 extras are still a work in progress, and the interface has some rough edges and disadvantages we hope to address over time. The primary area with room for improvement is the debugging story: errors are not easy to track down, and runtime debugging is most often done with print statements. In the future, we hope to integrate V8 extras into Chromium’s developer tools and tracing framework, both for Chromium itself and for any embedders that speak the same protocol.<p>Another cause for caution when using V8 extras is the extra developer effort required to write secure and robust code. V8 extras code operates directly on the snapshot, just like the code for V8’s self-hosted built-ins. It accesses the same objects as userland JavaScript, with no binding layer or separate context to prevent such access. For example, something as seemingly-simple as <code>global.Object.prototype.hasOwnProperty.call(obj, 5)</code> has six potential ways in which it could fail due to user code modifying the built-ins (count them!). Embedders like Chromium need to be robust against any user code, no matter its behavior, and so in such environments more care is necessary when writing extras than when writing traditional C++-implemented features.<p>If you’d like to learn more about V8 extras, check out our <a href="https://docs.google.com/document/d/1AT5-T0aHGp7Lt29vPWFr2-qG8r3l9CByyvKwEuA8Ec0/edit#heading=h.32abkvzeioyz">design document</a> which goes into much more detail. We look forward to improving V8 extras, and adding more features that allow developers and embedders to write expressive, high-performance additions to the V8 runtime.</div><footer><div><picture><source srcset="/_img/avatars/domenic-denicola.avif, /_img/avatars/domenic-denicola@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/domenic-denicola.jpg srcset="/_img/avatars/domenic-denicola@2x.jpg 2x" width=96></picture><p>作者：Domenic Denicola (<a href=https://twitter.com/domenic>@domenic</a>), Streams Sorcerer.</div></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/v8-extras>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/v8-extras.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>