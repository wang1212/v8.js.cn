<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Speeding up V8 regular expressions · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="V8 recently migrated RegExp’s built-in functions from a self-hosted JavaScript implementation to one that hooks straight into our new code generation architecture based on TurboFan." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Speeding up V8 regular expressions</h1><p class=meta>发布时间 <time datetime="2017-01-10 13:33:37" itemprop=datePublished title="2017-01-10 13:33:37">2017-01-10</time> · 标签： <a href=/blog/tags/internals/ class=tag>internals</a> <a href=/blog/tags/regexp/ class=tag>RegExp</a></header><div itemprop=articleBody><p>This blog post covers V8’s recent migration of RegExp’s built-in functions from a self-hosted JavaScript implementation to one that hooks straight into our new code generation architecture based on <a href=/blog/v8-release-56>TurboFan</a>.<p>V8’s RegExp implementation is built on top of <a href=https://blog.chromium.org/2009/02/irregexp-google-chromes-new-regexp.html>Irregexp</a>, which is widely considered to be one of the fastest RegExp engines. While the engine itself encapsulates the low-level logic to perform pattern matching against strings, functions on the RegExp prototype such as <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/exec><code>RegExp.prototype.exec</code></a> do the additional work required to expose its functionality to the user.<p>Historically, various components of V8 have been implemented in JavaScript. Until recently, <code>regexp.js</code> has been one of them, hosting the implementation of the RegExp constructor, all of its properties as well as its prototype’s properties.<p>Unfortunately this approach has disadvantages, including unpredictable performance and expensive transitions to the C++ runtime for low-level functionality. The recent addition of built-in subclassing in ES6 (allowing JavaScript developers to provide their own customized RegExp implementation) has resulted in a further RegExp performance penalty, even if the RegExp built-in is not subclassed. These regressions could not be fully addressed in the self-hosted JavaScript implementation.<p>We therefore decided to migrate the RegExp implementation away from JavaScript. However, preserving performance turned out to be more difficult than expected. An initial migration to a full C++ implementation was significantly slower, reaching only around 70% of the original implementation’s performance. After some investigation, we found several causes:<ul><li><a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/exec><code>RegExp.prototype.exec</code></a> contains a couple of extremely performance-sensitive areas, most notably including the transition to the underlying RegExp engine, and construction of the RegExp result with its associated substring calls. For these, the JavaScript implementation relied on highly optimized pieces of code called “stubs”, written either in native assembly language or by hooking directly into the optimizing compiler pipeline. It is not possible to access these stubs from C++, and their runtime equivalents are significantly slower.<li>Accesses to properties such as RegExp’s <code>lastIndex</code> can be expensive, possibly requiring lookups by name and traversal of the prototype chain. V8’s optimizing compiler can often automatically replace such accesses with more efficient operations, while these cases would need to be handled explicitly in C++.<li>In C++, references to JavaScript objects must be wrapped in so-called <code>Handle</code>s in order to cooperate with garbage collection. Handle management produces further overhead in comparison to the plain JavaScript implementation.</ul><p>Our new design for the RegExp migration is based on the <a href=/blog/csa>CodeStubAssembler</a>, a mechanism that allows V8 developers to write platform-independent code which will later be translated into fast, platform-specific code by the same backend that is also used for the new optimizing compiler TurboFan. Using the CodeStubAssembler allows us to address all shortcomings of the initial C++ implementation. Stubs (such as the entry-point into the RegExp engine) can easily be called from the CodeStubAssembler. While fast property accesses still need to be explicitly implemented on so-called fast paths, such accesses are extremely efficient in the CodeStubAssembler. Handles simply do not exist outside of C++. And since the implementation now operates at a very low level, we can take further shortcuts such as skipping expensive result construction when it is not needed.<p>Results have been very positive. Our score on <a href=https://github.com/chromium/octane/blob/master/regexp.js>a substantial RegExp workload</a> has improved by 15%, more than regaining our recent subclassing-related performance losses. Microbenchmarks (Figure 1) show improvements across the board, from 7% for <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/exec><code>RegExp.prototype.exec</code></a>, up to 102% for <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/@@split><code>RegExp.prototype[@@split]</code></a>.<figure><img alt="" height=576 loading=lazy src=/_img/speeding-up-regular-expressions/perf.png width=1024><figcaption>Figure 1: RegExp speedup broken down by function</figcaption></figure><p>So how can you, as a JavaScript developer, ensure that your RegExps are fast? If you are not interested in hooking into RegExp internals, make sure that neither the RegExp instance, nor its prototype is modified in order to get the best performance:<pre class=language-js><code class=language-js><span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token language-regex regex-source">.</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span><br>re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Fast path.</span><br>re<span class="token punctuation">.</span>new_property <span class="token operator">=</span> <span class="token string">'slow'</span><span class="token punctuation">;</span><br><span class="token class-name">RegExp</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>new_property <span class="token operator">=</span> <span class="token string">'also slow'</span><span class="token punctuation">;</span><br>re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Slow path.</span></code></pre><p>And while RegExp subclassing may be quite useful at times, be aware that subclassed RegExp instances require more generic handling and thus take the slow path:<pre class=language-js><code class=language-js><span class="token keyword">class</span> <span class="token class-name">SlowRegExp</span> <span class="token keyword">extends</span> <span class="token class-name">RegExp</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><span class="token keyword">new</span> <span class="token class-name">SlowRegExp</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Slow path.</span></code></pre><p>The full RegExp migration will be available in V8 v5.7.</div><footer><div><picture><source srcset="/_img/avatars/jakob-gruber.avif, /_img/avatars/jakob-gruber@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/jakob-gruber.jpg width=96 srcset="/_img/avatars/jakob-gruber@2x.jpg 2x"></picture><p>作者：Jakob Gruber, Regular Software Engineer.</div></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/speeding-up-regular-expressions>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/speeding-up-regular-expressions.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>