<!doctype html><html lang=zh-CN><meta charset=utf-8><title>V8 release v7.4 · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="V8 v7.4 features WebAssembly threads/Atomics, private class fields, performance and memory improvements, and much more!" name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>V8 release v7.4</h1><p class=meta>发布时间 <time datetime="2019-03-22 16:30:42" itemprop=datePublished title="2019-03-22 16:30:42">2019-03-22</time> · 标签： <a href=/blog/tags/release/ class=tag>release</a></header><div itemprop=articleBody><p>Every six weeks, we create a new branch of V8 as part of our <a href=/docs/release-process>release process</a>. Each version is branched from V8’s Git master immediately before a Chrome Beta milestone. Today we’re pleased to announce our newest branch, <a href=https://chromium.googlesource.com/v8/v8.git/+log/branch-heads/7.4>V8 version 7.4</a>, which is in beta until its release in coordination with Chrome 74 Stable in several weeks. V8 v7.4 is filled with all sorts of developer-facing goodies. This post provides a preview of some of the highlights in anticipation of the release.<h2 id=jit-less-v8>JIT-less V8 <a href=#jit-less-v8 class=bookmark>#</a></h2><p>V8 now supports <em>JavaScript</em> execution without allocating executable memory at runtime. In-depth information on this feature can be found in the <a href=/blog/jitless>dedicated blog post</a>.<h2 id=webassembly-threads%2Fatomics-shipped>WebAssembly Threads/Atomics shipped <a href=#webassembly-threads%2Fatomics-shipped class=bookmark>#</a></h2><p>WebAssembly Threads/Atomics are now enabled on non-Android operating systems. This concludes the <a href=/blog/v8-release-70#a-preview-of-webassembly-threads>origin trial/preview we enabled in V8 v7.0</a>. A Web Fundamentals article explains <a href=https://developers.google.com/web/updates/2018/10/wasm-threads>how to use WebAssembly Atomics with Emscripten</a>.<p>This unlocks the usage of multiple cores on a user’s machine via WebAssembly, enabling new, computation-heavy use cases on the web.<h2 id=performance>Performance <a href=#performance class=bookmark>#</a></h2><h3 id=faster-calls-with-arguments-mismatch>Faster calls with arguments mismatch <a href=#faster-calls-with-arguments-mismatch class=bookmark>#</a></h3><p>In JavaScript it’s perfectly valid to call functions with too few or too many parameters (i.e. pass fewer or more than the declared formal parameters). The former is called <em>under-application</em>, the latter is called <em>over-application</em>. In case of under-application, the remaining formal parameters get assigned <code>undefined</code>, while in case of over-application, the superfluous parameters are ignored.<p>However, JavaScript functions can still get to the actual parameters by means of the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/arguments><code>arguments</code> object</a>, by using <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/rest_parameters>rest parameters</a>, or even by using the non-standard <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/arguments><code>Function.prototype.arguments</code> property</a> on <a href=https://developer.mozilla.org/en-US/docs/Glossary/Sloppy_mode>sloppy mode</a> functions. As a result, JavaScript engines must provide a way to get to the actual parameters. In V8 this is done via a technique called <em>arguments adaption</em>, which provides the actual parameters in case of under- or over-application. Unfortunately, arguments adaption comes at a performance cost, and is needed commonly in modern front-end and middleware frameworks (i.e. lots of APIs with optional parameters or variable argument lists).<p>There are scenarios where the engine knows that arguments adaption is not necessary since the actual parameters cannot be observed, namely when the callee is a strict mode function, and uses neither <code>arguments</code> nor rest parameters. In these cases, V8 now completely skips arguments adaption, reducing call overhead by up to <strong>60%</strong>.<figure><img alt="" height=290 loading=lazy src=/_img/v8-release-74/argument-mismatch-performance.svg width=600><figcaption>Performance impact of skipping arguments adaption, as measured through <a href=https://gist.github.com/bmeurer/4916fc2b983acc9ee1d33f5ee1ada1d3#file-bench-call-overhead-js>a micro-benchmark</a>.</figcaption></figure><p>The graph shows that there’s no overhead anymore, even in case of an arguments mismatch (assuming that the callee cannot observe the actual arguments). For more details, see the <a href=https://bit.ly/v8-faster-calls-with-arguments-mismatch>design document</a>.<h3 id=improved-native-accessor-performance>Improved native accessor performance <a href=#improved-native-accessor-performance class=bookmark>#</a></h3><p>The Angular team <a href=https://mhevery.github.io/perf-tests/DOM-megamorphic.html>discovered</a> that calling into native accessors (i.e. DOM property accessors) directly via their respective <code>get</code> functions was significantly slower in Chrome than the <a href=https://en.wikipedia.org/wiki/Inline_caching#Monomorphic_inline_caching>monomorphic</a> or even the <a href=https://en.wikipedia.org/wiki/Inline_caching#Megamorphic_inline_caching>megamorphic</a> property access. This was due to taking the slow-path in V8 for calling into DOM accessors via <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/call><code>Function#call()</code></a>, instead of the fast-path that was already there for property accesses.<figure><img alt="" height=271 loading=lazy src=/_img/v8-release-74/native-accessor-performance.svg width=600></figure><p>We managed to improve the performance of calling into native accessors, making it significantly faster than the megamorphic property access. For more background, see <a href="https://bugs.chromium.org/p/v8/issues/detail?id=8820">V8 issue #8820</a>.<h3 id=parser-performance>Parser performance <a href=#parser-performance class=bookmark>#</a></h3><p>In Chrome, large enough scripts are “streaming”-parsed on worker threads while they are being downloaded. In this release we identified and fixed a performance issue with custom UTF-8 decoding used by the source stream, leading to an average 8% faster streaming parse.<p>We found an additional issue in V8’s preparser, which most commonly runs on a worker thread: property names were unnecessarily deduplicated. Removing this deduplication improved the streaming parser by another 10.5%. This also improves main-thread parse time of scripts that aren’t streamed, like small scripts and inline scripts.<figure><img alt="" height=244 loading=lazy src=/_img/v8-release-74/parser-performance.jpg width=1069 srcset="/_img/v8-release-74/parser-performance@2x.jpg 2x"><figcaption>Each drop in the above chart represents one of the performance improvements in the streaming parser.</figcaption></figure><h2 id=memory>Memory <a href=#memory class=bookmark>#</a></h2><h3 id=bytecode-flushing>Bytecode flushing <a href=#bytecode-flushing class=bookmark>#</a></h3><p>Bytecode compiled from JavaScript source takes up a significant chunk of V8 heap space, typically around 15%, including related meta-data. There are many functions which are only executed during initialization, or rarely used after having been compiled.<p>In order to reduce V8’s memory overhead, we have implemented support for flushing compiled bytecode from functions during garbage collection if they haven’t been executed recently. In order to enable this, we keep track of the age of a function’s bytecode, incrementing the age during garbage collections, and resetting it to zero when the function is executed. Any bytecode which crosses an aging threshold is eligible to be collected by the next garbage collection, and the function resets to lazily recompile its bytecode if it is ever executed again in the future.<p>Our experiments with bytecode flushing show that it provides significant memory savings for users of Chrome, reducing the amount of memory in V8’s heap by between 5–15% while not regressing performance or significantly increasing the amount of CPU time spent compiling JavaScript code.<figure><img alt="" height=271 loading=lazy src=/_img/v8-release-74/bytecode-flushing.svg width=600></figure><h3 id=bytecode-dead-basic-block-elimination>Bytecode dead basic block elimination <a href=#bytecode-dead-basic-block-elimination class=bookmark>#</a></h3><p>The Ignition bytecode compiler attempts to avoid generating code that it knows to be dead, e.g. code after a <code>return</code> or <code>break</code> statement:<pre class=language-js><code class=language-js><span class="token keyword">return</span><span class="token punctuation">;</span><br><span class="token function">deadCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// skipped</span></code></pre><p>However, previously this was done opportunistically for terminating statements in a statement list, so it did not take into account other optimizations, such as shortcutting conditions that are known to be true:<pre class=language-js><code class=language-js><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">2.2</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br><span class="token function">deadCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// not skipped</span></code></pre><p>We tried to resolve this in V8 v7.3, but still on a per-statement level, which wouldn’t work when the control flow became more involved, e.g.<pre class=language-js><code class=language-js><span class="token keyword">do</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">2.2</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token keyword">break</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">deadCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// not skipped</span></code></pre><p>The <code>deadCall()</code> above would be at the start of a new basic block, which on a per-statement level is reachable as a target for <code>break</code> statements in the loop.<p>In V8 v7.4, we allow entire basic blocks to become dead, if no <code>Jump</code> bytecode (Ignition’s main control flow primitive) refers to them. In the above example, the <code>break</code> is not emitted, which means the loop has no <code>break</code> statements. So, the basic block starting with <code>deadCall()</code> has no referring jumps, and thus is also considered dead. While we don’t expect this to have a large impact on user code, it is particularly useful for simplifying various desugarings, such as generators, <code>for-of</code> and <code>try-catch</code>, and in particular removes a class of bugs where basic blocks could “resurrect” complex statements part-way through their implementation.<h2 id=javascript-language-features>JavaScript language features <a href=#javascript-language-features class=bookmark>#</a></h2><h3 id=private-class-fields>Private class fields <a href=#private-class-fields class=bookmark>#</a></h3><p>V8 v7.2 added support for the public class fields syntax. Class fields simplify class syntax by avoiding the need for constructor functions just to define instance properties. Starting in V8 v7.4, you can mark a field as private by prepending it with a <code>#</code> prefix.<pre class=language-js><code class=language-js><span class="token keyword">class</span> <span class="token class-name">IncreasingCounter</span> <span class="token punctuation">{</span><br>  #count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Getting the current value!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#count<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>#count<span class="token operator">++</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Unlike public fields, private fields are not accessible outside of the class body:<pre class=language-js><code class=language-js><span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IncreasingCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>counter<span class="token punctuation">.</span>#count<span class="token punctuation">;</span><br><span class="token comment">// → SyntaxError</span><br>counter<span class="token punctuation">.</span>#count <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><br><span class="token comment">// → SyntaxError</span></code></pre><p>For more information, read our <a href=/features/class-fields>explainer on public and private class fields</a>.<h3 id=intl.locale><code>Intl.Locale</code> <a href=#intl.locale class=bookmark>#</a></h3><p>JavaScript applications generally use strings such as <code>'en-US'</code> or <code>'de-CH'</code> to identify locales. <code>Intl.Locale</code> offers a more powerful mechanism to deal with locales, and enables easily extracting locale-specific preferences such as the language, the calendar, the numbering system, the hour cycle, and so on.<pre class=language-js><code class=language-js><span class="token keyword">const</span> locale <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intl<span class="token punctuation">.</span>Locale</span><span class="token punctuation">(</span><span class="token string">'es-419-u-hc-h12'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  calendar<span class="token operator">:</span> <span class="token string">'gregory'</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>locale<span class="token punctuation">.</span>language<span class="token punctuation">;</span><br><span class="token comment">// → 'es'</span><br>locale<span class="token punctuation">.</span>calendar<span class="token punctuation">;</span><br><span class="token comment">// → 'gregory'</span><br>locale<span class="token punctuation">.</span>hourCycle<span class="token punctuation">;</span><br><span class="token comment">// → 'h12'</span><br>locale<span class="token punctuation">.</span>region<span class="token punctuation">;</span><br><span class="token comment">// → '419'</span><br>locale<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → 'es-419-u-ca-gregory-hc-h12'</span></code></pre><h3 id=hashbang-grammar>Hashbang grammar <a href=#hashbang-grammar class=bookmark>#</a></h3><p>JavaScript programs can now start with <code>#!</code>, a so-called <a href=https://github.com/tc39/proposal-hashbang>hashbang</a>. The rest of the line following the hashbang is treated as a single-line comment. This matches de facto usage in command-line JavaScript hosts, such as Node.js. The following is now a syntactically valid JavaScript program:<pre class=language-js><code class=language-js>#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node<br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id=v8-api>V8 API <a href=#v8-api class=bookmark>#</a></h2><p>Please use <code>git log branch-heads/7.3..branch-heads/7.4 include/v8.h</code> to get a list of the API changes.<p>Developers with an <a href=/docs/source-code#using-git>active V8 checkout</a> can use <code>git checkout -b 7.4 -t branch-heads/7.4</code> to experiment with the new features in V8 v7.4. Alternatively you can <a href=https://www.google.com/chrome/browser/beta.html>subscribe to Chrome’s Beta channel</a> and try the new features out yourself soon.</div><footer><div><p>作者：Georg Neis.</div><a href=https://twitter.com/v8js/status/1109094755936489472 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/v8-release-74>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/v8-release-74.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>