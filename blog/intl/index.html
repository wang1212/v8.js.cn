<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Faster and more feature-rich internationalization APIs · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="The JavaScript Internationalization API is growing, and its V8 implementation is getting faster!" name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Faster and more feature-rich internationalization APIs</h1><p class=meta>发布时间 <time datetime="2019-04-25 16:45:37" itemprop=datePublished title="2019-04-25 16:45:37">2019-04-25</time> · 标签： <a href=/blog/tags/ecmascript/ class=tag>ECMAScript</a> <a href=/blog/tags/intl/ class=tag>Intl</a></header><div itemprop=articleBody><p><a href=https://tc39.es/ecma402/ >The ECMAScript Internationalization API Specification</a> (ECMA-402, or <code>Intl</code>) provides key locale-specific functionality such as date formatting, number formatting, plural form selection, and collation. The Chrome V8 and Google Internationalization teams have been collaborating on adding features to V8’s ECMA-402 implementation, while cleaning up technical debt and improving performance and interoperability with other browsers.<h2 id=underlying-architectural-improvements>Underlying architectural improvements <a href=#underlying-architectural-improvements class=bookmark>#</a></h2><p>Initially the ECMA-402 spec was implemented mostly in JavaScript using V8-extensions and lived outside the V8 codebase. Using the external Extension API meant that several of V8’s internally used APIs for type checking, lifetime management of external C++ objects and internal private data storage couldn’t be used. As part of improving startup performance, this implementation was later moved in to the V8 codebase to enable <a href=/blog/custom-startup-snapshots>snapshotting</a> of these builtins.<p>V8 uses specialized <code>JSObject</code>s with custom <a href=https://mathiasbynens.be/notes/shapes-ics>shapes (hidden classes)</a> to describe built-in JavaScript objects specified by ECMAScript (like <code>Promise</code>s, <code>Map</code>s, <code>Set</code>s, etc). With this approach, V8 can pre-allocate the required number of internal slots and generate fast accesses to these, rather than grow the object one property at a time leading to slower performance and worse memory usage.<p>The <code>Intl</code> implementation was not modeled after such an architecture, as a consequence of the historic split. Instead, all the built-in JavaScript objects as specified by the Internationalization spec (like <code>NumberFormat</code>, <code>DateTimeFormat</code>) were generic <code>JSObject</code>s that had to transition through several property additions for their internal slots.<p>Another artifact of not having a specialized <code>JSObject</code>s was that type checking was now more complex. The type information was stored under a private symbol and type-checked on both the JS and C++ side using expensive property access, rather than just looking up its shape.<h3 id=modernizing-the-codebase>Modernizing the codebase <a href=#modernizing-the-codebase class=bookmark>#</a></h3><p>With the current move away from writing self-hosted builtins in V8, it made sense to use this opportunity to modernize the ECMA402 implementation.<h3 id=moving-away-from-self-hosted-js>Moving away from self-hosted JS <a href=#moving-away-from-self-hosted-js class=bookmark>#</a></h3><p>Although self-hosting lends itself to concise and readable code, the frequent usage of slow runtime calls to access ICU APIs led to performance issues. As a result, a lot of ICU functionality was duplicated in JavaScript to reduce the number of such runtime calls.<p>By rewriting the builtins in C++, it became much faster to access the ICU APIs as there is no runtime call overhead now.<h3 id=improving-icu>Improving ICU <a href=#improving-icu class=bookmark>#</a></h3><p>ICU is a set of C/C++ libraries used by a large set of applications, including all the major JavaScript engines, for providing Unicode and globalization support. As part of switching <code>Intl</code> to ICU in V8’s implementation, we <a href=https://unicode-org.atlassian.net/browse/ICU-20140>found</a> <a href=https://unicode-org.atlassian.net/browse/ICU-9562>and</a> <a href=https://unicode-org.atlassian.net/browse/ICU-20098>fixed</a> several ICU bugs.<p>As part of implementing new proposals such as <a href=/features/intl-relativetimeformat><code>Intl.RelativeTimeFormat</code></a>, <a href=/features/intl-listformat><code>Intl.ListFormat</code></a> and <code>Intl.Locale</code>, we’ve extended ICU by adding <a href=https://unicode-org.atlassian.net/browse/ICU-13256>several</a> <a href=https://unicode-org.atlassian.net/browse/ICU-20121>new</a> <a href=https://unicode-org.atlassian.net/browse/ICU-20342>APIs</a> to support these new ECMAScript proposals.<p>All of these additions help other JavaScript engines implement these proposals quicker now, pushing the web forward! For example, development is in progress in Firefox on implementing several new <code>Intl</code> APIs based on our ICU work.<h2 id=performance>Performance <a href=#performance class=bookmark>#</a></h2><p>As a result of this work, we improved the performance of the Internationalization API by optimizing several fast paths and caching the initialization of the various <code>Intl</code> objects and the <code>toLocaleString</code> methods on <code>Number.prototype</code>, <code>Date.prototype</code>, and <code>String.prototype</code>.<p>For example, creating a new <code>Intl.NumberFormat</code> object became around 24× faster.<figure><img alt="" height=371 loading=lazy src=/_img/intl/performance.svg width=713><figcaption><a href=https://cs.chromium.org/chromium/src/v8/test/js-perf-test/Intl/constructor.js>Microbenchmarks</a> testing the performance of creating various <code>Intl</code> objects</figcaption></figure><p>Note that for better performance, it’s recommended to explicitly create <em>and reuse</em> an <code>Intl.NumberFormat</code> or <code>Intl.DateTimeFormat</code> or <code>Intl.Collator</code> object, rather than calling methods like <code>toLocaleString</code> or <code>localeCompare</code>.<h2 id=new-intl-features>New <code>Intl</code> features <a href=#new-intl-features class=bookmark>#</a></h2><p>All of this work has provided a great foundation to build new features on and we’re continuing to ship all the new Internationalization proposals that are in Stage 3.<p><a href=/features/intl-relativetimeformat><code>Intl.RelativeTimeFormat</code></a> has shipped in Chrome 71, <a href=/features/intl-listformat><code>Intl.ListFormat</code></a> has shipped in Chrome 72, <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Locale><code>Intl.Locale</code></a> has shipped in Chrome 74, and <a href=https://github.com/tc39/proposal-intl-datetime-style><code>dateStyle</code> and <code>timeStyle</code> options for <code>Intl.DateTimeFormat</code></a> and <a href=https://github.com/tc39/ecma402/pull/236>BigInt support for <code>Intl.DateTimeFormat</code></a> are shipping in Chrome 76. <a href=https://github.com/tc39/proposal-intl-DateTimeFormat-formatRange><code>Intl.DateTimeFormat#formatRange</code></a>, <a href=https://github.com/tc39/proposal-intl-segmenter/ ><code>Intl.Segmenter</code></a>, and <a href=https://github.com/tc39/proposal-unified-intl-numberformat/ >additional options for <code>Intl.NumberFormat</code></a> are currently under development in V8, and we hope to ship them soon!<p>Many of these new APIs, and others further down the pipeline, are due to our work on standardizing new features to help developers with internationalization. <a href=https://github.com/tc39/proposal-intl-displaynames><code>Intl.DisplayNames</code></a> is a Stage 1 proposal that allows users to localize the display names of language, region or script display names. <a href=https://github.com/fabalbon/proposal-intl-DateTimeFormat-formatRange><code>Intl.DateTimeFormat#formatRange</code></a> is a Stage 3 proposal that specifies a way to format date ranges in a concise and locale-aware manner. <a href=https://github.com/tc39/proposal-unified-intl-numberformat>The unified <code>Intl.NumberFormat</code> API proposal</a> is a Stage 3 proposal that improves <code>Intl.NumberFormat</code> by adding support for measurement units, currency and sign display policies, and scientific and compact notation. You can get involved in the future of ECMA-402 as well, by contributing at <a href=https://github.com/tc39/ecma402>its GitHub repository</a>.<h2 id=conclusion>Conclusion <a href=#conclusion class=bookmark>#</a></h2><p><code>Intl</code> provides a feature-rich API for several operations needed in internationalizing your web app, leaving the heavy lifting to the browser, without shipping as much data or code over the wire. Thinking through the proper use of these APIs can lead your UI to work better in different locales. Due to the work by the Google V8 and i18n teams in collaboration with TC39 and its ECMA-402 subgroup, you can now access more functionality with better performance, and expect further improvements over time.</div><footer><div><picture><source srcset="/_img/avatars/sathya-gunasekaran.avif, /_img/avatars/sathya-gunasekaran@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/sathya-gunasekaran.jpg width=96 srcset="/_img/avatars/sathya-gunasekaran@2x.jpg 2x"></picture><p>作者：<a href=https://twitter.com/_gsathya>சத்யா குணசேகரன் (Sathya Gunasekaran)</a>.</div><a href=https://twitter.com/v8js/status/1121424877142122500 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/intl>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/intl.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>