<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Indicium: V8 runtime tracer tool · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="Indicium: V8 system analyzer tool to analyze Map/IC events." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Indicium: V8 runtime tracer tool</h1><p class=meta>发布时间 <time datetime="2020-10-01 11:56:00" itemprop=datePublished title="2020-10-01 11:56:00">2020-10-01</time> · 标签： <a href=/blog/tags/tools/ class=tag>tools</a> <a href=/blog/tags/system-analyzer/ class=tag>system-analyzer</a></header><div itemprop=articleBody><h1 id=indicium%3A-v8-system-analyzer>Indicium: V8 system analyzer <a href=#indicium%3A-v8-system-analyzer class=bookmark>#</a></h1><p>The past three months have been an awesome learning experience for me as I've joined the V8 team (Google London) as an intern, and have been working on a new tool called <a href=https://v8.dev/tools/head/system-analyzer><em>Indicium</em></a>.<p>This system analyzer is a unified web interface to trace, debug and analyse patterns of how Inline Caches (ICs) and Maps are created and modified in real-world applications.<p>V8 already has a tracing infrastructure for <a href=https://mathiasbynens.be/notes/shapes-ics>ICs</a> and <a href=https://v8.dev/blog/fast-properties>Maps</a> which can process and analyse IC events using the <a href=https://v8.dev/tools/v8.7/ic-explorer.html>IC Explorer</a> and Map events using <a href=https://v8.dev/tools/v8.7/map-processor.html>Map Processor</a>. However, previous tools didn't allow us to analyze maps and ICs holistically and this is now possible with system analyzer.<figure><img alt="" height=145 loading=lazy src=/_img/system-analyzer/indicium-logo.png width=122><figcaption>Indicium</figcaption></figure><h2 id=case-study>Case Study <a href=#case-study class=bookmark>#</a></h2><p>Let’s go through an example to demonstrate how we can use the Indicium to analyse Map and IC log events in V8.<pre class=language-javascript><code class=language-javascript><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>isNegative <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">dotProduct</span><span class="token punctuation">(</span><span class="token parameter">other</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">*</span> other<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">*</span> other<span class="token punctuation">.</span>y<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">let</span> dotProduct<span class="token punctuation">;</span><br><br><span class="token comment">// warmup</span><br><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10e5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  dotProduct <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'snippet1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10e6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  dotProduct <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br>console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'snippet1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'snippet2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10e6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  dotProduct <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br>console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'snippet2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Here, we have a <code>Point</code> class that stores two coordinates and an additional boolean based on the values of the co-ordinates. The <code>Point</code> class has a <code>dotProduct</code> method which returns the dot product between the passed object and the receiver.<p>To make explaining the program easier, let’s break the program into two snippets (ignoring the warmup phase):<h3 id=snippet-1><em>snippet 1</em> <a href=#snippet-1 class=bookmark>#</a></h3><pre class=language-javascript><code class=language-javascript><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">let</span> dotProduct<span class="token punctuation">;</span><br><br>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'snippet1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10e6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  dotProduct <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br>console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'snippet1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id=snippet-2><em>snippet 2</em> <a href=#snippet-2 class=bookmark>#</a></h3><pre class=language-javascript><code class=language-javascript>a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'snippet2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10e6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  dotProduct <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br>console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'snippet2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Once we run the program we notice a performance regression. Even though we are measuring the performance of two similar snippets; accessing the properties <code>x</code> and <code>y</code> of <code>Point</code> object instances by calling the <code>dotProduct</code> function in a for-loop.<p>Snippet 1 runs approximately 3 times faster than snippet 2. The only difference being that we use negative values for <code>x</code> and <code>y</code> properties in the <code>Point</code> object in snippet 2.<figure><img alt="" height=371 loading=lazy src=/_img/system-analyzer/initial-program-performance.png width=600><figcaption>Performance analysis of snippets.</figcaption></figure><p>To analyse this performance difference we can use various logging options that come with V8. This is where the system analyzer shines. It can display log events and link them together with map events letting us explore the magic that is hidden within V8.<p>Before diving more into the case study, let’s get familiar with the panels of the system analyzer tool. The tool has four main panels:<ul><li>a Timeline panel to analyse Map/ICs events across time,<li>a Map panel to visualise the transition trees of the maps,<li>an IC panel to get statistics about the IC events,<li>a Source panel to display Map/IC file positions on a script.</ul><figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/system-analyzer-overview.png width=960><figcaption>System Analyzer Overview</figcaption></figure><figure><img alt="" height=706 loading=lazy src=/_img/system-analyzer/case1_1.png width=954><figcaption>Group IC events by function name to get in depth information about the IC events associated with the <code>dotProduct</code>.</figcaption></figure><p>We are analyzing how the function <code>dotProduct</code> might be causing this performance difference. So we group IC events by functionName to get more in depth information about IC events associated with the <code>dotProduct</code> function.<p>The first thing we notice is that we have two different IC state transitions recorded by the IC events in this function. One going from uninitialised to monomorphic and the other one going from monomorphic to polymorphic. Polymorphic IC state indicates that now we are tracking more than one Map associated with <code>Point</code> objects and this polymorphic state is worse as we have to perform additional checks.<p>We want to know why we are creating multiple Map shapes for the same type of objects. To do so, we toggle the info button about IC state to get more information about the Map addresses going from uninitialised to monomorphic.<figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/case1_2.png width=960><figcaption>The map transition tree associated with the monomorphic IC state.</figcaption></figure><figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/case1_3.png width=960><figcaption>The map transition tree associated with the polymorphic IC state.</figcaption></figure><p>For the monomorphic IC state we can visualise the transition tree and see that we are only dynamically adding two properties <code>x</code>and <code>y</code> but when it comes to polymorphic IC state, we have a new Map containing three properties <code>isNegative</code>, <code>x</code> and <code>y</code>.<figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/case1_4.png width=960><figcaption>The Map panel communicates the file position information to highlight file positions on the Source panel.</figcaption></figure><p>We click on the file position section of the Map panel to see where this <code>isNegative</code> property is added in the source code and can use this insight to address the performance regression.<p>So now the question being <em>how can we address the performance regression by using the insight we generated from the tool</em>?<p>The minimal solution would be to always initialise the <code>isNegative</code> property. In general, it is sound advice that all instance properties should be initialised in the constructor.<p>Now, the updated <code>Point</code> class looks like this:<pre class=language-javascript><code class=language-javascript><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>isNegative <span class="token operator">=</span> x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">dotProduct</span><span class="token punctuation">(</span><span class="token parameter">other</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">*</span> other<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">*</span> other<span class="token punctuation">.</span>y<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>If we execute the script again with the modified <code>Point</code> class, we see that the execution of the two snippets defined at the beginning of the case study perform very similarly.<p>In an updated trace, we see that the polymorphic IC state is avoided as we are not creating multiple maps for the same type of objects.<figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/case2_1.png width=960><figcaption>The map transition tree of the modified Point object.</figcaption></figure><h2 id=the-system-analyzer>The System Analyzer <a href=#the-system-analyzer class=bookmark>#</a></h2><p>Let's now have an in-depth look at the different panels that are present in the system analyzer.<h3 id=timeline-panel>Timeline Panel <a href=#timeline-panel class=bookmark>#</a></h3><p>The Timeline panel allows selection in time which enables visualization of IC/map states across discrete points in time or a selected range in time. It supports filtering features such as zoom in/out to the log events for selected time ranges.<figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/timeline-panel.png width=960><figcaption>Timeline panel overview</figcaption></figure><figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/timeline-panel2.png width=960><figcaption>Timeline panel overview (Cont.)</figcaption></figure><h3 id=map-panel>Map Panel <a href=#map-panel class=bookmark>#</a></h3><p>The Map panel has two sub panels:<ol><li>Map details<li>Map transitions</ol><p>The Map panel visualizes the transition trees of selected maps. The metadata of the selected map displayed through the map details sub-panel. A specific transition tree associated with a map address can be searched for using the provided interface. From the Stats sub-panel, which is above the Map transitions sub-panel, we can see the statistics about the properties causing map transitions and types of map events.<figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/map-panel.png width=960><figcaption>Map panel overview</figcaption></figure><figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/stats-panel.png width=960><figcaption>Stats panel overview</figcaption></figure><h3 id=ic-panel>IC Panel <a href=#ic-panel class=bookmark>#</a></h3><p>The IC panel displays statistics about IC events falling within a specific time range which are filtered through the Timeline panel. Additionally, the IC panel allows grouping IC events based on various options (type, category, map, file position.). From the grouping options, map and file position grouping option interacts with map and source code panels respectively to display the transition trees of maps and highlight the file positions associated with the IC events.<figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/ic-panel.png width=960><figcaption>IC panel Overview</figcaption></figure><figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/ic-panel2.png width=960><figcaption>IC panel overview (Cont.)</figcaption></figure><figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/ic-panel3.png width=960><figcaption>IC panel Overview (Cont.)</figcaption></figure><figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/ic-panel4.png width=960><figcaption>IC panel overview (Cont.)</figcaption></figure><h3 id=source-panel>Source Panel <a href=#source-panel class=bookmark>#</a></h3><p>The Source panel displays the loaded scripts with clickable markers to emit custom events which selects both Map and IC log events across the custom panels. Selection of a loaded script can be done from the drill down bar. Selecting a file position from Map panel and IC panel highlights the selected file position on the source code panel.<figure><img alt="" height=720 loading=lazy src=/_img/system-analyzer/source-panel.png width=960><figcaption>Source panel Overview</figcaption></figure><h3 id=acknowledgements>Acknowledgements <a href=#acknowledgements class=bookmark>#</a></h3><p>I would like to thank everyone in the V8 and Web on Android teams, especially to my host Sathya and co-host Camillo for supporting me throughout my internship and giving me the opportunity to work on such a cool project.<p>I had an amazing summer interning at Google!</div><footer><div><picture><source srcset="/_img/avatars/zeynep-cankara.avif, /_img/avatars/zeynep-cankara@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/zeynep-cankara.jpg width=96 srcset="/_img/avatars/zeynep-cankara@2x.jpg 2x"></picture><p>作者：Zeynep Cankara (<a href=https://twitter.com/ZeynepCankara>@ZeynepCankara</a>).</div><a href=https://twitter.com/v8js/status/1311689392608731140 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/system-analyzer>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/system-analyzer.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>