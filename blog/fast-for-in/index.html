<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Fast for-in in V8 · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="This technical deep-dive explains how V8 made JavaScript’s for-in as fast as possible." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Fast <code>for</code>-<code>in</code> in V8</h1><p class=meta>发布时间 <time datetime="2017-03-01 13:33:37" itemprop=datePublished title="2017-03-01 13:33:37">2017-03-01</time> · 标签： <a href=/blog/tags/internals/ class=tag>internals</a></header><div itemprop=articleBody><p><code>for</code>-<code>in</code> is a widely used language feature present in many frameworks. Despite its ubiquity, it is one of the more obscure language constructs from an implementation perspective. V8 went to great lengths to make this feature as fast as possible. Over the course of the past year, <code>for</code>-<code>in</code> became fully spec-compliant and up to 3 times faster, depending on the context.<p>Many popular websites rely heavily on for-in and benefit from its optimization. For example, in early 2016 Facebook spent roughly 7% of its total JavaScript time during startup in the implementation of <code>for</code>-<code>in</code> itself. On Wikipedia this number was even higher at around 8%. By improving the performance of certain slow cases, Chrome 51 significantly improved the performance on these two websites:<figure><img alt="" height=166 loading=lazy src=/_img/fast-for-in/wikipedia.png width=979></figure><figure><img alt="" height=165 loading=lazy src=/_img/fast-for-in/facebook.png width=991></figure><p>Wikipedia and Facebook both improved their total script time by 4% due to various <code>for</code>-<code>in</code> improvements. Note that during the same period, the rest of V8 also got faster, which yielded a total scripting improvement of more than 4%.<p>In the rest of this blog post we will explain how we managed to speed up this core language feature and fix a long-standing spec violation at the same time.<h2 id=the-spec>The spec <a href=#the-spec class=bookmark>#</a></h2><p><em><strong>TL;DR;</strong> The for-in iteration semantics are fuzzy for performance reasons.</em><p>When we look at the <a href=https://tc39.es/ecma262/#sec-for-in-and-for-of-statements>spec-text of <code>for</code>-<code>in</code>, it’s written in an unexpectedly fuzzy way</a>, which is observable across different implementations. Let's look at an example when iterating over a <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy>Proxy</a> object with the proper traps set.<pre class=language-js><code class=language-js><span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getPrototypeOf'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ownKeys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getOwnPropertyDescriptor name='</span> <span class="token operator">+</span> prop<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In V8/Chrome 56 you get the following output:<pre><code>ownKeys
getPrototypeOf
getOwnPropertyDescriptor name=a
a
getOwnPropertyDescriptor name=b
b
</code></pre><p>In contrast, you get a different order of statements for the same snippet in Firefox 51:<pre><code>ownKeys
getOwnPropertyDescriptor name=a
getOwnPropertyDescriptor name=b
getPrototypeOf
a
b
</code></pre><p>Both browsers respect the spec, but for once the spec does not enforce an explicit order of instructions. To understand these loop holes properly, let's have a look at the spec text:<blockquote><p>EnumerateObjectProperties ( O )<br>When the abstract operation EnumerateObjectProperties is called with argument O, the following steps are taken:<ol><li>Assert: Type(O) is Object.<li>Return an Iterator object (25.1.1.2) whose next method iterates over all the String-valued keys of enumerable properties of O. The iterator object is never directly accessible to ECMAScript code. The mechanics and order of enumerating the properties is not specified but must conform to the rules specified below.</ol></blockquote><p>Now, usually spec instructions are precise in what exact steps are required. But in this case they refer to a simple list of prose, and even the order of execution is left to implementers. Typically, the reason for this is that such parts of the spec were written after the fact where JavaScript engines already had different implementations. The spec tries to tie the loose ends by providing the following instructions:<ol><li>The iterator's throw and return methods are null and are never invoked.<li>The iterator's next method processes object properties to determine whether the property key should be returned as an iterator value.<li>Returned property keys do not include keys that are Symbols.<li>Properties of the target object may be deleted during enumeration.<li>A property that is deleted before it is processed by the iterator's next method is ignored. If new properties are added to the target object during enumeration, the newly added properties are not guaranteed to be processed in the active enumeration.<li>A property name will be returned by the iterator's next method at most once in any enumeration.<li>Enumerating the properties of the target object includes enumerating properties of its prototype, and the prototype of the prototype, and so on, recursively; but a property of a prototype is not processed if it has the same name as a property that has already been processed by the iterator's next method.<li>The values of <code>[[Enumerable]]</code> attributes are not considered when determining if a property of a prototype object has already been processed.<li>The enumerable property names of prototype objects must be obtained by invoking EnumerateObjectProperties passing the prototype object as the argument.<li>EnumerateObjectProperties must obtain the own property keys of the target object by calling its <code>[[OwnPropertyKeys]]</code> internal method.</ol><p>These steps sound tedious, however the specification also contains an example implementation which is explicit and much more readable:<pre class=language-js><code class=language-js><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">EnumerateObjectProperties</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> key <span class="token operator">===</span> <span class="token string">'symbol'</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> desc <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>desc <span class="token operator">&&</span> <span class="token operator">!</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token punctuation">.</span>enumerable<span class="token punctuation">)</span> <span class="token keyword">yield</span> key<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">const</span> proto <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>proto <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> protoKey <span class="token keyword">of</span> <span class="token function">EnumerateObjectProperties</span><span class="token punctuation">(</span>proto<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>protoKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">yield</span> protoKey<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Now that you've made it this far, you might have noticed from the previous example that V8 does not exactly follow the spec example implementation. As a start, the example for-in generator works incrementally, while V8 collects all keys upfront - mostly for performance reasons. This is perfectly fine, and in fact the spec text explicitly states that the order of operations A - J is not defined. Nevertheless, as you will find out later in this post, there are some corner cases where V8 did not fully respect the specification until 2016.<h2 id=the-enum-cache>The enum cache <a href=#the-enum-cache class=bookmark>#</a></h2><p>The example implementation of the <code>for</code>-<code>in</code> generator follows an incremental pattern of collecting and yielding keys. In V8 the property keys are collected in a first step and only then used in the iteration phase. For V8 this makes a few things easier. To understand why, we need to have a look at the object model.<p>A simple object such as <code>{a:'value a', b:'value b', c:'value c'}</code> can have various internal representations in V8 as we will show in a detailed follow-up post on properties. This means that depending on what type of properties we have — in-object, fast, or slow — the actual property names are stored in different places. This makes collecting enumerable keys a non-trivial undertaking.<p>V8 keeps track of the object's structure by means of a hidden class or so-called Map. Objects with the same Map have the same structure. Additionally each Map has a shared data-structure, the descriptor array, which contains details about each property, such as where the properties are stored on the object, the property name, and details such as enumerability.<p>Let’s for a moment assume that our JavaScript object has reached its final shape and no more properties will be added or removed. In this case we could use the descriptor array as a source for the keys. This works if there are only enumerable properties. To avoid the overhead of filtering out non-enumerable properties each time V8 uses a separate EnumCache accessible via the Map's descriptor array.<figure><img alt="" height=99 loading=lazy src=/_img/fast-for-in/enum-cache.png width=621></figure><p>Given that V8 expects that slow dictionary objects frequently change, (i.e. through addition and removal of properties), there is no descriptor array for slow objects with dictionary properties. Hence, V8 does not provide an EnumCache for slow properties. Similar assumptions hold for indexed properties, and as such they are excluded from the EnumCache as well.<p>Let’s summarize the important facts:<ul><li>Maps are used to keep track of object shapes.<li>Descriptor arrays store information about properties (name, configurability, visibility).<li>Descriptor arrays can be shared between Maps.<li>Each descriptor array can have an EnumCache listing only the enumerable named keys, not indexed property names.</ul><h2 id=the-mechanics-of-for-in>The mechanics of <code>for</code>-<code>in</code> <a href=#the-mechanics-of-for-in class=bookmark>#</a></h2><p>Now you know partially how Maps work and how the EnumCache relates to the descriptor array. V8 executes JavaScript via Ignition, a bytecode interpreter, and TurboFan, the optimizing compiler, which both deal with for-in in similar ways. For simplicity we will use a pseudo-C++ style to explain how for-in is implemented internally:<pre class=language-js><code class=language-js><span class="token comment">// For-In Prepare:</span><br>FixedArray<span class="token operator">*</span> keys <span class="token operator">=</span> nullptr<span class="token punctuation">;</span><br>Map<span class="token operator">*</span> original_map <span class="token operator">=</span> object<span class="token operator">-</span><span class="token operator">></span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span>original_map<span class="token operator">-</span><span class="token operator">></span><span class="token function">HasEnumCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-</span><span class="token operator">></span><span class="token function">HasNoElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    keys <span class="token operator">=</span> original_map<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCachedEnumKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    keys <span class="token operator">=</span> object<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCachedEnumKeysWithElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>  keys <span class="token operator">=</span> object<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetEnumKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// For-In Body:</span><br><span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token operator">-</span><span class="token operator">></span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// For-In Next:</span><br>  String<span class="token operator">*</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>object<span class="token operator">-</span><span class="token operator">></span><span class="token function">HasProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><br>  <span class="token constant">EVALUATE_FOR_IN_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>For-in can be separated into three main steps:<ol><li>Preparing the keys to iterate over,<li>Getting the next key,<li>Evaluating the <code>for</code>-<code>in</code> body.</ol><p>The "prepare" step is the most complex out of these three and this is the place where the EnumCache comes into play. In the example above you can see that V8 directly uses the EnumCache if it exists and if there are no elements (integer indexed properties) on the object (and its prototype). For the case where there are indexed property names, V8 jumps to a runtime function implemented in C++ which prepends them to the existing enum cache, as illustrated by the following example:<pre class=language-cpp><code class=language-cpp>FixedArray<span class="token operator">*</span> <span class="token class-name">JSObject</span><span class="token operator">::</span><span class="token function">GetCachedEnumKeysWithElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  FixedArray<span class="token operator">*</span> keys <span class="token operator">=</span> object<span class="token operator">-></span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetCachedEnumKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> object<span class="token operator">-></span><span class="token function">GetElementsAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">PrependElementIndices</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>FixedArray<span class="token operator">*</span> <span class="token class-name">Map</span><span class="token operator">::</span><span class="token function">GetCachedEnumKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Get the enumerable property keys from a possibly shared enum cache</span><br>  FixedArray<span class="token operator">*</span> keys_cache <span class="token operator">=</span> <span class="token function">descriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">enum_cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">keys_cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">enum_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> keys_cache<span class="token operator">-></span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> keys_cache<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> keys_cache<span class="token operator">-></span><span class="token function">CopyUpTo</span><span class="token punctuation">(</span><span class="token function">enum_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>FixedArray<span class="token operator">*</span> <span class="token class-name">FastElementsAccessor</span><span class="token operator">::</span><span class="token function">PrependElementIndices</span><span class="token punctuation">(</span><br>      JSObject<span class="token operator">*</span> object<span class="token punctuation">,</span> FixedArray<span class="token operator">*</span> property_keys<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">Assert</span><span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">HasFastElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  FixedArray<span class="token operator">*</span> elements <span class="token operator">=</span> object<span class="token operator">-></span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">int</span> nof_indices <span class="token operator">=</span> <span class="token function">CountElements</span><span class="token punctuation">(</span>elements<span class="token punctuation">)</span><br>  FixedArray<span class="token operator">*</span> result <span class="token operator">=</span> <span class="token class-name">FixedArray</span><span class="token operator">::</span><span class="token function">Allocate</span><span class="token punctuation">(</span>property_keys<span class="token operator">-></span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> nof_indices<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">int</span> insertion_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> elements<span class="token operator">-></span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">HasElement</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><br>    result<span class="token punctuation">[</span>insertion_index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">String</span><span class="token operator">::</span><span class="token function">FromInt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// Insert property keys at the end.</span><br>  property_keys<span class="token operator">-></span><span class="token function">CopyTo</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> nof_indices <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>In the case where no existing EnumCache was found we jump again to C++ and follow the initially presented spec steps:<pre class=language-cpp><code class=language-cpp>FixedArray<span class="token operator">*</span> <span class="token class-name">JSObject</span><span class="token operator">::</span><span class="token function">GetEnumKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Get the receiver’s enum keys.</span><br>  FixedArray<span class="token operator">*</span> keys <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">GetOwnEnumKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Walk up the prototype chain.</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span>JSObject<span class="token operator">*</span> object <span class="token operator">:</span> <span class="token function">GetPrototypeIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>     <span class="token comment">// Append non-duplicate keys to the list.</span><br>     keys <span class="token operator">=</span> keys<span class="token operator">-></span><span class="token function">UnionOfKeys</span><span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">GetOwnEnumKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">return</span> keys<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>FixedArray<span class="token operator">*</span> <span class="token class-name">JSObject</span><span class="token operator">::</span><span class="token function">GetOwnEnumKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  FixedArray<span class="token operator">*</span> keys<span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span><span class="token function">HasEnumCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    keys <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetCachedEnumKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    keys <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">GetEnumPropertyKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span><span class="token function">HasFastProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FillEnumCache</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> object<span class="token operator">-></span><span class="token function">GetElementsAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">PrependElementIndices</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>FixedArray<span class="token operator">*</span> <span class="token class-name">FixedArray</span><span class="token operator">::</span><span class="token function">UnionOfKeys</span><span class="token punctuation">(</span>FixedArray<span class="token operator">*</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  FixedArray<span class="token operator">*</span> result <span class="token operator">=</span> <span class="token class-name">FixedArray</span><span class="token operator">::</span><span class="token function">Allocate</span><span class="token punctuation">(</span>length <span class="token operator">+</span> other<span class="token operator">-></span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">CopyTo</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">int</span> insertion_index <span class="token operator">=</span> length<span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> other<span class="token operator">-></span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    String<span class="token operator">*</span> key <span class="token operator">=</span> other<span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token operator">-></span><span class="token function">IndexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      result<span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span>insertion_index<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      insertion_index<span class="token operator">++</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br>  result<span class="token operator">-></span><span class="token function">Shrink</span><span class="token punctuation">(</span>insertion_index<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>This simplified C++ code corresponds to the implementation in V8 until early 2016 when we started to look at the UnionOfKeys method. If you look closely you notice that we used a naive algorithm to exclude duplicates from the list which might yield bad performance if we have many keys on the prototype chain. This is how we decided to pursue the optimizations in following section.<h2 id=problems-with-for-in>Problems with <code>for</code>-<code>in</code> <a href=#problems-with-for-in class=bookmark>#</a></h2><p>As we already hinted in the previous section, the UnionOfKeys method has bad worst-case performance. It was based on the valid assumption that most objects have fast properties and thus will benefit from an EnumCache. The second assumption is that there are only few enumerable properties on the prototype chain limiting the time spent in finding duplicates. However, if the object has slow dictionary properties and many keys on the prototype chain, UnionOfKeys becomes a bottleneck as we have to collect the enumerable property names each time we enter for-in.<p>Next to performance issues, there was another problem with the existing algorithm in that it’s not spec compliant. V8 got the following example wrong for many years:<pre class=language-js><code class=language-js><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><br>  __proto__ <span class="token operator">:</span> <span class="token punctuation">{</span>b<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>  a<span class="token operator">:</span> <span class="token number">1</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token keyword">in</span> o<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Output:<pre><code>a
b
</code></pre><p>Perhaps counterintuitively this should just print out <code>a</code> instead of <code>a</code> and <code>b</code>. If you recall the spec text at the beginning of this post, steps G and J imply that non-enumerable properties on the receiver shadow properties on the prototype chain.<p>To make things more complicated, ES6 introduced the <a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Proxy>proxy</a> object. This broke a lot of assumptions of the V8 code. To implement for-in in a spec-compliant manner, we have to trigger the following 5 out of a total of 13 different proxy traps.<div class=table-wrapper><table><thead><tr><th>Internal method<th>Handler method<tbody><tr><td><code>[[GetPrototypeOf]]</code><td><code>getPrototypeOf</code><tr><td><code>[[GetOwnProperty]]</code><td><code>getOwnPropertyDescriptor</code><tr><td><code>[[HasProperty]]</code><td><code>has</code><tr><td><code>[[Get]]</code><td><code>get</code><tr><td><code>[[OwnPropertyKeys]]</code><td><code>ownKeys</code></table></div><p>This required a duplicate version of the original GetEnumKeys code which tried to follow the spec example implementation more closely. ES6 Proxies and lack of handling shadowing properties were the core motivation for us to refactor how we extract all the keys for for-in in early 2016.<h2 id=the-keyaccumulator>The <code>KeyAccumulator</code> <a href=#the-keyaccumulator class=bookmark>#</a></h2><p>We introduced a separate helper class, the <code>KeyAccumulator</code>, which dealt with the complexities of collecting the keys for <code>for</code>-<code>in</code>. With growth of the ES6 spec, new features like <code>Object.keys</code> or <code>Reflect.ownKeys</code> required their own slightly modified version of collecting keys. By having a single configurable place we could improve the performance of <code>for</code>-<code>in</code> and avoid duplicated code.<p>The <code>KeyAccumulator</code> consists of a fast part that only supports a limited set of actions but is able to complete them very efficiently. The slow accumulator supports all the complex cases, like ES6 Proxies.<figure><img alt="" height=96 loading=lazy src=/_img/fast-for-in/keyaccumulator.png width=624></figure><p>In order to properly filter out shadowing properties we have to maintain a separate list of non-enumerable properties that we have seen so far. For performance reasons we only do this after we figure out that there are enumerable properties on the prototype chain of an object.<h2 id=performance-improvements>Performance improvements <a href=#performance-improvements class=bookmark>#</a></h2><p>With the <code>KeyAccumulator</code> in place, a few more patterns became feasible to optimize. The first one was to avoid the nested loop of the original UnionOfKeys method which caused slow corner cases. In a second step we performed more detailed pre-checks to make use of existing EnumCaches and avoid unnecessary copy steps.<p>To illustrate that the spec-compliant implementation is faster, let’s have a look at the following four different objects:<pre class=language-js><code class=language-js><span class="token keyword">var</span> fastProperties <span class="token operator">=</span> <span class="token punctuation">{</span><br>  __proto__ <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  <span class="token string">'property 1'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>  …<br>  <span class="token string">'property 10'</span><span class="token operator">:</span> n<br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> fastPropertiesWithPrototype <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token string">'property 1'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>  …<br>  <span class="token string">'property 10'</span><span class="token operator">:</span> n<br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> slowProperties <span class="token operator">=</span> <span class="token punctuation">{</span><br>  __proto__ <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  <span class="token string">'dummy'</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  <span class="token string">'property 1'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>  …<br>  <span class="token string">'property 10'</span><span class="token operator">:</span> n<br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">delete</span> slowProperties<span class="token punctuation">[</span><span class="token string">'dummy'</span><span class="token punctuation">]</span><br><br><span class="token keyword">var</span> elements <span class="token operator">=</span> <span class="token punctuation">{</span><br>  __proto__<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  <span class="token string">'1'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>  …<br>  <span class="token string">'10'</span><span class="token operator">:</span> n<br><span class="token punctuation">}</span></code></pre><ul><li>The <code>fastProperties</code> object has standard fast properties.<li>The <code>fastPropertiesWithPrototype</code> object has additional non-enumerable properties on the prototype chain by using the <code>Object.prototype</code>.<li>The <code>slowProperties</code> object has slow dictionary properties.<li>The <code>elements</code> object has only indexed properties.</ul><p>The following graph compares the original performance of running a <code>for</code>-<code>in</code> loop a million times in a tight loop without the help of our optimizing compiler.<figure><img alt="" height=345 loading=lazy src=/_img/fast-for-in/keyaccumulator-benchmark.png width=938></figure><p>As we've outlined in the introduction, these improvements became very visible on Wikipedia and Facebook in particular.<figure><img alt="" height=166 loading=lazy src=/_img/fast-for-in/wikipedia.png width=979></figure><figure><img alt="" height=165 loading=lazy src=/_img/fast-for-in/facebook.png width=991></figure><p>Besides the initial improvements available in Chrome 51, a second performance tweak yielded another significant improvement. The following graph shows our tracking data of the total time spent in scripting during startup on a Facebook page. The selected range around V8 revision 37937 corresponds to an additional 4% performance improvement!<figure><img alt="" height=209 loading=lazy src=/_img/fast-for-in/fastkeyaccumulator.png width=784></figure><p>To underline the importance of improving <code>for</code>-<code>in</code> we can rely on the data from a tool we built back in 2016 that allows us to extract V8 measurements over a set of websites. The following table shows the relative time spent in V8 C++ entry points (runtime functions and builtins) for Chrome 49 over a set of roughly <a href=/blog/real-world-performance>25 representative real-world websites</a>.<div class=table-wrapper><table><thead><tr><th style=text-align:center>Position<th>Name<th>Total time<tbody><tr><td style=text-align:center>1<td><code>CreateObjectLiteral</code><td>1.10%<tr><td style=text-align:center>2<td><code>NewObject</code><td>0.90%<tr><td style=text-align:center>3<td><code>KeyedGetProperty</code><td>0.70%<tr><td style=text-align:center>4<td><code>GetProperty</code><td>0.60%<tr><td style=text-align:center>5<td><code>ForInEnumerate</code><td>0.60%<tr><td style=text-align:center>6<td><code>SetProperty</code><td>0.50%<tr><td style=text-align:center>7<td><code>StringReplaceGlobalRegExpWithString</code><td>0.30%<tr><td style=text-align:center>8<td><code>HandleApiCallConstruct</code><td>0.30%<tr><td style=text-align:center>9<td><code>RegExpExec</code><td>0.30%<tr><td style=text-align:center>10<td><code>ObjectProtoToString</code><td>0.30%<tr><td style=text-align:center>11<td><code>ArrayPush</code><td>0.20%<tr><td style=text-align:center>12<td><code>NewClosure</code><td>0.20%<tr><td style=text-align:center>13<td><code>NewClosure_Tenured</code><td>0.20%<tr><td style=text-align:center>14<td><code>ObjectDefineProperty</code><td>0.20%<tr><td style=text-align:center>15<td><code>HasProperty</code><td>0.20%<tr><td style=text-align:center>16<td><code>StringSplit</code><td>0.20%<tr><td style=text-align:center>17<td><code>ForInFilter</code><td>0.10%</table></div><p>The most important <code>for</code>-<code>in</code> helpers are at position 5 and 17, accounting for an average of 0.7% percent of the total time spent in scripting on a website. In Chrome 57 <code>ForInEnumerate</code> has dropped to 0.2% of the total time and <code>ForInFilter</code> is below the measuring threshold due to a fast path written in assembler.</div><footer><div><picture><source srcset="/_img/avatars/camillo-bruni.avif, /_img/avatars/camillo-bruni@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/camillo-bruni.jpg width=96 srcset="/_img/avatars/camillo-bruni@2x.jpg 2x"></picture><p>作者：Camillo Bruni (<a href=http://twitter.com/camillobruni>@camillobruni</a>).</div></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/fast-for-in>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/fast-for-in.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>