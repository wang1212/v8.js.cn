<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Cross-compiling and debugging for ARM/Android · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="This document explains how to cross-compile V8 for ARM/Android, and how to debug it." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li class=active><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><h1>Cross-compiling and debugging for ARM/Android</h1><p>First, make sure you can <a href=/docs/build-gn>build with GN</a>.<p>Then, add <code>android</code> to your <code>.gclient</code> configuration file.<pre class=language-python><code class=language-python>target_os <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'android'</span><span class="token punctuation">]</span>  <span class="token comment"># Add this to get Android stuff checked out.</span></code></pre><p>The <code>target_os</code> field is a list, so if you're also building on unix it'll look like this:<pre class=language-python><code class=language-python>target_os <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'android'</span><span class="token punctuation">,</span> <span class="token string">'unix'</span><span class="token punctuation">]</span>  <span class="token comment"># Multiple target OSes.</span></code></pre><p>Run <code>gclient sync</code>, and you’ll get a large checkout under <code>./third_party/android_tools</code>.<p>Enable developer mode on your phone or tablet, and turn on USB debugging, via instructions <a href=https://developer.android.com/studio/run/device.html>here</a>. Also, get the handy <a href=https://developer.android.com/studio/command-line/adb.html><code>adb</code></a> tool on your path. It’s in your checkout at <code>./third_party/android_sdk/public/platform-tools</code>.<h2 id=using-gm>Using <code>gm</code> <a href=#using-gm class=bookmark>#</a></h2><p>Use <a href=/docs/build-gn#gm>the <code>tools/dev/gm.py</code> script</a> to automatically build V8 tests and run them on the device.<pre class=language-bash><code class=language-bash><span class="token builtin class-name">alias</span> <span class="token variable assign-left">gm</span><span class="token operator">=</span>/path/to/v8/tools/dev/gm.py<br>gm android_arm.release.check</code></pre><p>This command pushes the binaries and tests to the <code>/data/local/tmp/v8</code> directory on the device.<h2 id=manual-build>Manual build <a href=#manual-build class=bookmark>#</a></h2><p>Use <code>v8gen.py</code> to generate an ARM release or debug build:<pre class=language-bash><code class=language-bash>tools/dev/v8gen.py arm.release</code></pre><p>Then run <code>gn args out.gn/arm.release</code> and make sure you have the following keys:<pre class=language-python><code class=language-python>target_os <span class="token operator">=</span> <span class="token string">"android"</span>      <span class="token comment"># These lines need to be changed manually</span><br>target_cpu <span class="token operator">=</span> <span class="token string">"arm"</span>         <span class="token comment"># as v8gen.py assumes a simulator build.</span><br>v8_target_cpu <span class="token operator">=</span> <span class="token string">"arm"</span><br>is_component_build <span class="token operator">=</span> false</code></pre><p>The keys should be the same for debug builds. If you are building for an arm64 device like the Pixel C, which supports 32bit and 64bit binaries, the keys should look like this:<pre class=language-python><code class=language-python>target_os <span class="token operator">=</span> <span class="token string">"android"</span>      <span class="token comment"># These lines need to be changed manually</span><br>target_cpu <span class="token operator">=</span> <span class="token string">"arm64"</span>       <span class="token comment"># as v8gen.py assumes a simulator build.</span><br>v8_target_cpu <span class="token operator">=</span> <span class="token string">"arm64"</span><br>is_component_build <span class="token operator">=</span> false</code></pre><p>Now build:<pre class=language-bash><code class=language-bash>ninja -C out.gn/arm.release d8</code></pre><p>Use <code>adb</code> to copy the binary and snapshot files to the phone:<pre class=language-bash><code class=language-bash>adb shell <span class="token string">'mkdir -p /data/local/tmp/v8/bin'</span><br>adb push out.gn/arm.release/d8 /data/local/tmp/v8/bin<br>adb push out.gn/arm.release/icudtl.dat /data/local/tmp/v8/bin<br>adb push out.gn/arm.release/snapshot_blob.bin /data/local/tmp/v8/bin</code></pre><pre class=language-bash><code class=language-bash>rebuffat:~/src/v8$ adb shell<br>bullhead:/ $ <span class="token builtin class-name">cd</span> /data/local/tmp/v8/bin<br>bullhead:/data/local/tmp/v8/bin $ <span class="token function">ls</span><br>v8 icudtl.dat snapshot_blob.bin<br>bullhead:/data/local/tmp/v8/bin $ ./d8<br>V8 version <span class="token number">5.8</span>.0 <span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><br>d<span class="token operator"><span class="token important file-descriptor">8</span>></span> <span class="token string">'w00t!'</span><br><span class="token string">"w00t!"</span><br>d<span class="token operator"><span class="token important file-descriptor">8</span>></span></code></pre><h2 id=debugging>Debugging <a href=#debugging class=bookmark>#</a></h2><h3 id=d8>d8 <a href=#d8 class=bookmark>#</a></h3><p>Remote debugging <code>d8</code> on an Android device is relatively simple. First start <code>gdbserver</code> on the Android device:<pre class=language-bash><code class=language-bash>bullhead:/data/local/tmp/v8/bin $ gdbserver :5039 <span class="token variable">$D8</span> <span class="token operator">&lt;</span>arguments<span class="token operator">></span></code></pre><p>Then connect to the server on your host device.<pre class=language-bash><code class=language-bash>adb forward tcp:5039 tcp:5039<br>gdb <span class="token variable">$D8</span><br>gdb<span class="token operator">></span> target remote :5039</code></pre><p><code>gdb</code> and <code>gdbserver</code> need to be compatible with each other, if in doubt use the binaries from the <a href=https://developer.android.com/ndk>Android NDK</a>. Note that by default the <code>d8</code> binary is stripped (debugging info removed), <code>$OUT_DIR/exe.unstripped/d8</code> contains the unstripped binary though.<h3 id=logging>Logging <a href=#logging class=bookmark>#</a></h3><p>By default, some of <code>d8</code>’s debugging output ends up in the Android system log, which can be dumped using <a href=https://developer.android.com/studio/command-line/logcat><code>logcat</code></a>. Unfortunately, sometimes part of a particular debugging output is split between system log and <code>adb</code>, and sometimes some part seems to be completely missing. To avoid these issues, it is recommended to add the following setting to the <code>gn args</code>:<pre class=language-python><code class=language-python>v8_android_log_stdout <span class="token operator">=</span> true</code></pre><h3 id=floating-point-issues>Floating-point issues <a href=#floating-point-issues class=bookmark>#</a></h3><p>The <code>gn args</code> setting <code>arm_float_abi = "hard"</code>, which is used by the V8 Arm GC Stress bot, can result in completely nonsensical program behavior on hardware different from the one the GC stress bot is using (e.g. on Nexus 7).<h2 id=using-sourcery-g%2B%2B-lite>Using Sourcery G++ Lite <a href=#using-sourcery-g%2B%2B-lite class=bookmark>#</a></h2><p>The Sourcery G++ Lite cross compiler suite is a free version of Sourcery G++ from <a href=http://www.codesourcery.com/ >CodeSourcery</a>. There is a page for the <a href=http://www.codesourcery.com/sgpp/lite/arm>GNU Toolchain for ARM Processors</a>. Determine the version you need for your host/target combination.<p>The following instructions use <a href=http://www.codesourcery.com/sgpp/lite/arm/portal/release858>2009q1-203 for ARM GNU/Linux</a>, and if using a different version please change the URLs and <code>TOOL_PREFIX</code> below accordingly.<h3 id=installing-on-host-and-target>Installing on host and target <a href=#installing-on-host-and-target class=bookmark>#</a></h3><p>The simplest way of setting this up is to install the full Sourcery G++ Lite package on both the host and target at the same location. This will ensure that all the libraries required are available on both sides. If you want to use the default libraries on the host there is no need the install anything on the target.<p>The following script installs in <code>/opt/codesourcery</code>:<pre class=language-bash><code class=language-bash><span class="token important shebang">#!/bin/sh</span><br><br><span class="token function">sudo</span> <span class="token function">mkdir</span> /opt/codesourcery<br><span class="token builtin class-name">cd</span> /opt/codesourcery<br><span class="token function">sudo</span> <span class="token function">chown</span> <span class="token string">"<span class="token variable">$USERNAME</span>"</span> <span class="token builtin class-name">.</span><br><span class="token function">chmod</span> g+ws <span class="token builtin class-name">.</span><br><span class="token builtin class-name">umask</span> <span class="token number">2</span><br><span class="token function">wget</span> http://www.codesourcery.com/sgpp/lite/arm/portal/package4571/public/arm-none-linux-gnueabi/arm-2009q1-203-arm-none-linux-gnueabi-i686-pc-linux-gnu.tar.bz2<br><span class="token function">tar</span> -xvf arm-2009q1-203-arm-none-linux-gnueabi-i686-pc-linux-gnu.tar.bz2</code></pre><h2 id=profile>Profile <a href=#profile class=bookmark>#</a></h2><ul><li><p>Compile a binary, push it to the device, keep a copy of it on the host:<pre class=language-bash><code class=language-bash>adb shell <span class="token function">cp</span> /data/local/tmp/v8/bin/d8 /data/local/tmp/v8/bin/d8-version.under.test<br><span class="token function">cp</span> out.gn/arm.release/d8 ./d8-version.under.test</code></pre><li><p>Get a profiling log and copy it to the host:<pre class=language-bash><code class=language-bash>adb push benchmarks /data/local/tmp<br>adb shell <span class="token builtin class-name">cd</span> /data/local/tmp/benchmarks<span class="token punctuation">;</span> <span class="token punctuation">..</span>/v8/bin/d8-version.under.test run.js --prof<br>adb shell /data/local/tmp/v8/bin/d8-version.under.test benchmark.js --prof<br>adb pull /data/local/tmp/benchmarks/v8.log ./</code></pre><li><p>Open <code>v8.log</code> in your favorite editor and edit the first line to match the full path of the <code>d8-version.under.test</code> binary on your workstation (instead of the <code>/data/local/tmp/v8/bin/</code> path it had on the device)<li><p>Run the tick processor with the host’s <code>d8</code> and an appropriate <code>nm</code> binary:<pre class=language-bash><code class=language-bash><span class="token function">cp</span> out/x64.release/d8 <span class="token builtin class-name">.</span>  <span class="token comment"># only required once</span><br><span class="token function">cp</span> out/x64.release/natives_blob.bin <span class="token builtin class-name">.</span>  <span class="token comment"># only required once</span><br><span class="token function">cp</span> out/x64.release/snapshot_blob.bin <span class="token builtin class-name">.</span>  <span class="token comment"># only required once</span><br>tools/linux-tick-processor --nm<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/third_party/android_ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin/arm-linux-androideabi-nm</code></pre></ul></main><footer id=footer><div><nav><a href=https://v8.dev/docs/cross-compile-arm>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/docs/cross-compile-arm.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>