<!doctype html><html lang=zh-CN><meta charset=utf-8><title>V8 Torque builtins · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="This document is intended as an introduction to writing Torque builtins, and is targeted towards V8 developers." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li class=active><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><h1>V8 Torque builtins</h1><p>This document is intended as an introduction to writing Torque builtins, and is targeted towards V8 developers. Torque replaces CodeStubAssembler as the recommended way to implement new builtins. See <a href=/docs/csa-builtins>CodeStubAssembler builtins</a> for the CSA version of this guide.<h2 id=builtins>Builtins <a href=#builtins class=bookmark>#</a></h2><p>In V8, builtins can be seen as chunks of code that are executable by the VM at runtime. A common use case is to implement the functions of builtin objects (such as <code>RegExp</code> or <code>Promise</code>), but builtins can also be used to provide other internal functionality (e.g. as part of the IC system).<p>V8’s builtins can be implemented using a number of different methods (each with different trade-offs):<ul><li><strong>Platform-dependent assembly language</strong>: can be highly efficient, but need manual ports to all platforms and are difficult to maintain.<li><strong>C++</strong>: very similar in style to runtime functions and have access to V8’s powerful runtime functionality, but usually not suited to performance-sensitive areas.<li><strong>JavaScript</strong>: concise and readable code, access to fast intrinsics, but frequent usage of slow runtime calls, subject to unpredictable performance through type pollution, and subtle issues around (complicated and non-obvious) JS semantics. Javascript builtins are deprecated and should not be added anymore.<li><strong>CodeStubAssembler</strong>: provides efficient low-level functionality that is very close to assembly language while remaining platform-independent and preserving readability.<li><strong><a href=/docs/torque>V8 Torque</a></strong>: is a V8-specific domain-specific language that is translated to CodeStubAssembler. As such, it extends upon CodeStubAssembler and offers static typing as well as readable and expressive syntax.</ul><p>The remaining document focuses on the latter and give a brief tutorial for developing a simple Torque builtin exposed to JavaScript. For more complete information about Torque, see the <a href=/docs/torque>V8 Torque user manual</a>.<h2 id=writing-a-torque-builtin>Writing a Torque builtin <a href=#writing-a-torque-builtin class=bookmark>#</a></h2><p>In this section, we will write a simple CSA builtin that takes a single argument, and returns whether it represents the number <code>42</code>. The builtin is exposed to JS by installing it on the <code>Math</code> object (because we can).<p>This example demonstrates:<ul><li>Creating a Torque builtin with JavaScript linkage, which can be called like a JS function.<li>Using Torque to implement simple logic: type distinction, Smi and heap-number handling, conditionals.<li>Installation of the CSA builtin on the <code>Math</code> object.</ul><p>In case you’d like to follow along locally, the following code is based off revision <a href=https://chromium.googlesource.com/v8/v8/+/589af9f257166f66774b4fb3008cd09f192c2614>589af9f2</a>.<h2 id=defining-mathis42>Defining <code>MathIs42</code> <a href=#defining-mathis42 class=bookmark>#</a></h2><p>Torque code is located in <code>src/builtins/*.tq</code> files, roughly organized by topic. Since we will be writing a <code>Math</code> builtin, we’ll put our definition into <code>src/builtins/math.tq</code>. Since this file doesn't exist yet, we have to add it to <a href="https://cs.chromium.org/chromium/src/v8/BUILD.gn?l=914&rcl=589af9f257166f66774b4fb3008cd09f192c2614"><code>torque_files</code></a> in <a href=https://cs.chromium.org/chromium/src/v8/BUILD.gn><code>BUILD.gn</code></a>.<pre class=language-torque><code class=language-torque><span class="token keyword">namespace</span> math <span class="token punctuation">{</span><br>  <span class="token keyword">javascript</span> <span class="token keyword">builtin</span> MathIs42<span class="token punctuation">(</span><br>      context<span class="token class-name">: Context,</span> receiver<span class="token class-name">: Object,</span> x<span class="token class-name">: Object)</span><span class="token class-name">: Boolean {</span><br>    <span class="token comment">// At this point, x can be basically anything - a Smi, a HeapNumber,</span><br>    <span class="token comment">// undefined, or any other arbitrary JS object. ToNumber_Inline is defined</span><br>    <span class="token comment">// in CodeStubAssembler. It inlines a fast-path (if the argument is a number</span><br>    <span class="token comment">// already) and calls the ToNumber builtin otherwise.</span><br>    <span class="token keyword">const</span> number<span class="token class-name">: Number =</span> ToNumber_Inline<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// A typeswitch allows us to switch on the dynamic type of a value. The type</span><br>    <span class="token comment">// system knows that a Number can only be a Smi or a HeapNumber, so this</span><br>    <span class="token comment">// switch is exhaustive.</span><br>    <span class="token keyword">typeswitch</span> <span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">case</span> <span class="token punctuation">(</span>smi<span class="token class-name">: Smi)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><br>        <span class="token comment">// The result of smi == 42 is not a Javascript boolean, so we use a</span><br>        <span class="token comment">// conditional to create a Javascript boolean value.</span><br>        <span class="token keyword">return</span> smi <span class="token operator">==</span> <span class="token number">42</span> <span class="token operator">?</span> <span class="token boolean">True</span> <span class="token class-name">: False;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">case</span> <span class="token punctuation">(</span>heapNumber<span class="token class-name">: HeapNumber)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token builtin">Convert</span><span class="token operator">&lt;</span>float64<span class="token operator">></span><span class="token punctuation">(</span>heapNumber<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">42</span> <span class="token operator">?</span> <span class="token boolean">True</span> <span class="token class-name">: False;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>We put the definition in the Torque namespace <code>math</code>. Since this namespace didn't exist before, we have to add it to <a href="https://cs.chromium.org/chromium/src/v8/BUILD.gn?l=933&rcl=589af9f257166f66774b4fb3008cd09f192c2614"><code>torque_namespaces</code></a> in <a href=https://cs.chromium.org/chromium/src/v8/BUILD.gn><code>BUILD.gn</code></a>.<h2 id=attaching-math.is42>Attaching <code>Math.is42</code> <a href=#attaching-math.is42 class=bookmark>#</a></h2><p>Builtin objects such as <code>Math</code> are set up mostly in <a href="https://cs.chromium.org/chromium/src/v8/src/bootstrapper.cc?q=src/bootstrapper.cc+package:%5Echromium$&l=1"><code>src/bootstrapper.cc</code></a> (with some setup occurring in <code>.js</code> files). Attaching our new builtin is simple:<pre class=language-cpp><code class=language-cpp><span class="token comment">// Existing code to set up Math, included here for clarity.</span><br>Handle<span class="token operator">&lt;</span>JSObject<span class="token operator">></span> math <span class="token operator">=</span> factory<span class="token operator">-></span><span class="token function">NewJSObject</span><span class="token punctuation">(</span>cons<span class="token punctuation">,</span> TENURED<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token class-name">JSObject</span><span class="token operator">::</span><span class="token function">AddProperty</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> name<span class="token punctuation">,</span> math<span class="token punctuation">,</span> DONT_ENUM<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// […snip…]</span><br><span class="token function">SimpleInstallFunction</span><span class="token punctuation">(</span>isolate_<span class="token punctuation">,</span> math<span class="token punctuation">,</span> <span class="token string">"is42"</span><span class="token punctuation">,</span> Builtins<span class="token operator">::</span>kMathIs42<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Now that <code>is42</code> is attached, it can be called from JS:<pre class=language-bash><code class=language-bash>$ out/debug/d8<br>d<span class="token operator"><span class="token file-descriptor important">8</span>></span> Math.is42<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token boolean">true</span><br>d<span class="token operator"><span class="token file-descriptor important">8</span>></span> Math.is42<span class="token punctuation">(</span><span class="token string">'42.0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token boolean">true</span><br>d<span class="token operator"><span class="token file-descriptor important">8</span>></span> Math.is42<span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token boolean">false</span><br>d<span class="token operator"><span class="token file-descriptor important">8</span>></span> Math.is42<span class="token punctuation">(</span><span class="token punctuation">{</span> valueOf: <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">42</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token boolean">true</span></code></pre><h2 id=defining-and-calling-a-builtin-with-stub-linkage>Defining and calling a builtin with stub linkage <a href=#defining-and-calling-a-builtin-with-stub-linkage class=bookmark>#</a></h2><p>Builtins can also be created with stub linkage (instead of JS linkage as we used above in <code>MathIs42</code>). Such builtins can be useful to extract commonly-used code into a separate code object that can be used by multiple callers, while the code is only produced once. Let’s extract the code that handles heap numbers into a separate builtin called <code>HeapNumberIs42</code>, and call it from <code>MathIs42</code>.<p>The definition is also straightforward. The only difference to our builtin with Javascript linkage is that we omit the keyword <code>javascript</code> and there is no receiver argument.<pre class=language-torque><code class=language-torque><span class="token keyword">namespace</span> math <span class="token punctuation">{</span><br>  <span class="token keyword">builtin</span> HeapNumberIs42<span class="token punctuation">(</span><span class="token keyword">implicit</span> context<span class="token class-name">: Context)</span><span class="token punctuation">(</span>heapNumber<span class="token class-name">: HeapNumber)</span><span class="token class-name">:<br>      Boolean {</span><br>    <span class="token keyword">return</span> <span class="token builtin">Convert</span><span class="token operator">&lt;</span>float64<span class="token operator">></span><span class="token punctuation">(</span>heapNumber<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">42</span> <span class="token operator">?</span> <span class="token boolean">True</span> <span class="token class-name">: False;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">javascript</span> <span class="token keyword">builtin</span> MathIs42<span class="token punctuation">(</span><span class="token keyword">implicit</span> context<span class="token class-name">: Context)</span><span class="token punctuation">(</span><br>      receiver<span class="token class-name">: Object,</span> x<span class="token class-name">: Object)</span><span class="token class-name">: Boolean {</span><br>    <span class="token keyword">const</span> number<span class="token class-name">: Number =</span> ToNumber_Inline<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">typeswitch</span> <span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">case</span> <span class="token punctuation">(</span>smi<span class="token class-name">: Smi)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> smi <span class="token operator">==</span> <span class="token number">42</span> <span class="token operator">?</span> <span class="token boolean">True</span> <span class="token class-name">: False;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">case</span> <span class="token punctuation">(</span>heapNumber<span class="token class-name">: HeapNumber)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Instead of handling heap numbers inline, we now call our new builtin.</span><br>        <span class="token keyword">return</span> HeapNumberIs42<span class="token punctuation">(</span>heapNumber<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Why should you care about builtins at all? Why not leave the code inline (or extracted into macros for better readability)?<p>An important reason is code space: builtins are generated at compile-time and included in the V8 snapshot or embedded into the binary. Extracting large chunks of commonly used code to separate builtins can quickly lead to space savings in the 10s to 100s of KBs.<h2 id=testing-stub-linkage-builtins>Testing stub-linkage builtins <a href=#testing-stub-linkage-builtins class=bookmark>#</a></h2><p>Even though our new builtin uses a non-standard (at least non-C++) calling convention, it’s possible to write test cases for it. The following code can be added to <a href=https://cs.chromium.org/chromium/src/v8/test/cctest/compiler/test-run-stubs.cc><code>test/cctest/compiler/test-run-stubs.cc</code></a> to test the builtin on all platforms:<pre class=language-cpp><code class=language-cpp><span class="token function">TEST</span><span class="token punctuation">(</span>MathIsHeapNumber42<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  HandleAndZoneScope scope<span class="token punctuation">;</span><br>  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">main_isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  Heap<span class="token operator">*</span> heap <span class="token operator">=</span> isolate<span class="token operator">-></span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  Zone<span class="token operator">*</span> zone <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">main_zone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  StubTester <span class="token function">tester</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> zone<span class="token punctuation">,</span> Builtins<span class="token operator">::</span>kMathIs42<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  Handle<span class="token operator">&lt;</span>Object<span class="token operator">></span> result1 <span class="token operator">=</span> tester<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>Handle<span class="token operator">&lt;</span>Smi<span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">Smi</span><span class="token operator">::</span><span class="token function">FromInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isolate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">CHECK</span><span class="token punctuation">(</span>result1<span class="token operator">-></span><span class="token function">BooleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></main><footer id=footer><div><nav><a href=https://v8.dev/docs/torque-builtins>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/docs/torque-builtins.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>