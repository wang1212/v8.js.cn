<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Optional chaining · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/_css/feature-support.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="Optional chaining enables readable and concise expression of property accesses with built-in nullish checking." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li class=current><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Optional chaining</h1><p class=meta>发布时间 <time datetime="2019-08-27 00:00:00" itemprop=datePublished>2019-08-27</time> · 标签： <a href=/features/tags/ecmascript class=tag>ECMAScript</a> <a href=/features/tags/es2020 class=tag>ES2020</a></header><div itemprop=articleBody><p>Long chains of property accesses in JavaScript can be error-prone, as any of them might evaluate to <code>null</code> or <code>undefined</code> (also known as “nullish” values). Checking for property existence on each step easily turns into a deeply-nested structure of <code>if</code>-statements or a long <code>if</code>-condition replicating the property access chain:<pre class=language-js><code class=language-js><span class="token comment">// Error prone-version, could throw.</span><br><span class="token keyword">const</span> nameLength <span class="token operator">=</span> db<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">.</span>length<span class="token punctuation">;</span><br><br><span class="token comment">// Less error-prone, but harder to read.</span><br><span class="token keyword">let</span> nameLength<span class="token punctuation">;</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span>db <span class="token operator">&&</span> db<span class="token punctuation">.</span>user <span class="token operator">&&</span> db<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">)</span><br>  nameLength <span class="token operator">=</span> db<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">.</span>length<span class="token punctuation">;</span></code></pre><p>The above can also be expressed using the ternary operator, which doesn’t exactly help readability:<pre class=language-js><code class=language-js><span class="token keyword">const</span> nameLength <span class="token operator">=</span><br>  <span class="token punctuation">(</span>db<br>    <span class="token operator">?</span> <span class="token punctuation">(</span>db<span class="token punctuation">.</span>user<br>      <span class="token operator">?</span> <span class="token punctuation">(</span>db<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<br>        <span class="token operator">?</span> db<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">.</span>length<br>        <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><br>      <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><br>    <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id=optional-chaining>Introducing the optional chaining operator <a href=#optional-chaining class=bookmark>#</a></h2><p>Surely you don’t want to write code like that, so having some alternative is desirable. Some other languages offer an elegant solution to this problem with using a feature called “optional chaining”. According to <a href=https://github.com/tc39/proposal-optional-chaining>a recent spec proposal</a>, “an optional chain is a chain of one or more property accesses and function calls, the first of which begins with the token <code>?.</code>”.<p>Using the new optional chaining operator, we can rewrite the above example as follows:<pre class=language-js><code class=language-js><span class="token comment">// Still checks for errors and is much more readable.</span><br><span class="token keyword">const</span> nameLength <span class="token operator">=</span> db<span class="token operator">?.</span>user<span class="token operator">?.</span>name<span class="token operator">?.</span>length<span class="token punctuation">;</span></code></pre><p>What happens when <code>db</code>, <code>user</code>, or <code>name</code> is <code>undefined</code> or <code>null</code>? With the optional chaining operator, JavaScript initializes <code>nameLength</code> to <code>undefined</code> instead of throwing an error.<p>Notice that this behavior is also more robust than our check for <code>if (db && db.user && db.user.name)</code>. For instance, what if <code>name</code> was always guaranteed to be a string? We could change <code>name?.length</code> to <code>name.length</code>. Then, if <code>name</code> were an empty string, we would still get the correct <code>0</code> length. That is because the empty string is a falsy value: it behaves like <code>false</code> in an <code>if</code> clause. The optional chaining operator fixes this common source of bugs.<h2 id=additional-syntax-forms%3A-calls-and-dynamic-properties>Additional syntax forms: calls and dynamic properties <a href=#additional-syntax-forms%3A-calls-and-dynamic-properties class=bookmark>#</a></h2><p>There’s also a version of the operator for calling optional methods:<pre class=language-js><code class=language-js><span class="token comment">// Extends the interface with an optional method, which is present</span><br><span class="token comment">// only for admin users.</span><br><span class="token keyword">const</span> adminOption <span class="token operator">=</span> db<span class="token operator">?.</span>user<span class="token operator">?.</span>validateAdminAndGetPrefs<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>option<span class="token punctuation">;</span></code></pre><p>The syntax can feel unexpected, as the <code>?.()</code> is the actual operator, which applies to the expression <em>before</em> it.<p>There’s a third usage of the operator, namely the optional dynamic property access, which is done via <code>?.[]</code>. It either returns the value referenced by the argument in the brackets, or <code>undefined</code> if there’s no object to get the value from. Here’s a possible use case, following the example from above:<pre class=language-js><code class=language-js><span class="token comment">// Extends the capabilities of the static property access</span><br><span class="token comment">// with a dynamically generated property name.</span><br><span class="token keyword">const</span> optionName <span class="token operator">=</span> <span class="token string">'optional setting'</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> optionLength <span class="token operator">=</span> db<span class="token operator">?.</span>user<span class="token operator">?.</span>preferences<span class="token operator">?.</span><span class="token punctuation">[</span>optionName<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span></code></pre><p>This last form is also available for optionally indexing arrays, e.g.:<pre class=language-js><code class=language-js><span class="token comment">// If the `usersArray` is `null` or `undefined`,</span><br><span class="token comment">// then `userName` gracefully evaluates to `undefined`.</span><br><span class="token keyword">const</span> userIndex <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> userName <span class="token operator">=</span> usersArray<span class="token operator">?.</span><span class="token punctuation">[</span>userIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span></code></pre><p>The optional chaining operator can be combined with the <a href=/features/nullish-coalescing>nullish coalescing <code>??</code> operator</a> when a non-<code>undefined</code> default value is needed. This enables safe deep property access with a specified default value, addressing a common use case that previously required userland libraries such as <a href=https://lodash.dev/docs/4.17.15#get>lodash’s <code>_.get</code></a>:<pre class=language-js><code class=language-js><span class="token keyword">const</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span> names<span class="token operator">:</span> <span class="token punctuation">{</span> first<span class="token operator">:</span> <span class="token string">'Alice'</span><span class="token punctuation">,</span> last<span class="token operator">:</span> <span class="token string">'Smith'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token punctuation">{</span> <span class="token comment">// With lodash:</span><br>  <span class="token keyword">const</span> firstName <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'names.first'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// → 'Alice'</span><br><br>  <span class="token keyword">const</span> middleName <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'names.middle'</span><span class="token punctuation">,</span> <span class="token string">'(no middle name)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// → '(no middle name)'</span><br><span class="token punctuation">}</span><br><br><span class="token punctuation">{</span> <span class="token comment">// With optional chaining and nullish coalescing:</span><br>  <span class="token keyword">const</span> firstName <span class="token operator">=</span> object<span class="token operator">?.</span>names<span class="token operator">?.</span>first <span class="token operator">??</span> <span class="token string">'(no first name)'</span><span class="token punctuation">;</span><br>  <span class="token comment">// → 'Alice'</span><br><br>  <span class="token keyword">const</span> middleName <span class="token operator">=</span> object<span class="token operator">?.</span>names<span class="token operator">?.</span>middle <span class="token operator">??</span> <span class="token string">'(no middle name)'</span><span class="token punctuation">;</span><br>  <span class="token comment">// → '(no middle name)'</span><br><span class="token punctuation">}</span></code></pre><h2 id=properties>Properties of the optional chaining operator <a href=#properties class=bookmark>#</a></h2><p>The optional chaining operator has a few interesting properties: <em>short-circuiting</em>, <em>stacking</em>, and <em>optional deletion</em>. Let’s walk through each of these with an example.<p><em>Short-circuiting</em> means not evaluating the rest of the expression if an optional chaining operator returns early:<pre class=language-js><code class=language-js><span class="token comment">// `age` is incremented only if `db` and `user` are defined.</span><br>db<span class="token operator">?.</span>user<span class="token operator">?.</span><span class="token function">grow</span><span class="token punctuation">(</span><span class="token operator">++</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><em>Stacking</em> means that more than one optional chaining operator can be applied on a sequence of property accesses:<pre class=language-js><code class=language-js><span class="token comment">// An optional chain may be followed by another optional chain.</span><br><span class="token keyword">const</span> firstNameLength <span class="token operator">=</span> db<span class="token punctuation">.</span>users<span class="token operator">?.</span><span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">]</span><span class="token operator">?.</span>names<span class="token punctuation">.</span>first<span class="token punctuation">.</span>length<span class="token punctuation">;</span></code></pre><p>Still, be considerate about using more than one optional chaining operator in a single chain. If a value is guaranteed to not be nullish, then using <code>?.</code> to access properties on it is discouraged. In the example above, <code>db</code> is considered to always be defined, but <code>db.users</code> and <code>db.users[42]</code> may not be. If there’s such a user in the database, then <code>names.first.length</code> is assumed to always be defined.<p><em>Optional deletion</em> means that the <code>delete</code> operator can be combined with an optional chain:<pre class=language-js><code class=language-js><span class="token comment">// `db.user` is deleted only if `db` is defined.</span><br><span class="token keyword">delete</span> db<span class="token operator">?.</span>user<span class="token punctuation">;</span></code></pre><p>More details can be found in <a href=https://github.com/tc39/proposal-optional-chaining#semantics>the <em>Semantics</em> section of the proposal</a>.<h2 id=support>Support for optional chaining <a href=#support class=bookmark>#</a></h2><ul class=feature-support><li class="environment has-link has-support"><a href="https://bugs.chromium.org/p/v8/issues/detail?id=9553"><span class="icon chrome">Chrome:</span> <span class=support>自 <span class=version>80</span> 版本开始支持</span></a><li class="environment has-link has-support"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1566143"><span class="icon firefox">Firefox:</span> <span class=support>自 <span class=version>74</span> 版本开始支持</span></a><li class="environment has-link has-support"><a href="https://bugs.webkit.org/show_bug.cgi?id=200199"><span class="icon safari">Safari:</span> <span class=support>自 <span class=version>13.1</span> 版本开始支持</span></a><li class="environment has-link has-support"><a href=https://medium.com/@nodejs/node-js-version-14-available-now-8170d384567e><span class="icon nodejs">Node.js:</span> <span class=support>自 <span class=version>14</span> 版本开始支持</span></a><li class="environment has-link has-support"><a href=https://babeljs.io/docs/en/babel-plugin-proposal-optional-chaining><span class="icon babel">Babel:</span> <span class=support>支持</span></a></ul><div class=feature-support-info><a href=/features/support>关于特性支持列表</a></div></div><footer><div><picture><source srcset="/_img/avatars/maya-armyanova.avif, /_img/avatars/maya-armyanova@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/maya-armyanova.jpg srcset="/_img/avatars/maya-armyanova@2x.jpg 2x" width=96></picture><p>作者：Maya Armyanova (<a href=https://twitter.com/Zmayski>@Zmayski</a>), breaker of optional chains.</div><a href=https://twitter.com/v8js/status/1166360971914481669 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/features/optional-chaining>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/features/optional-chaining.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>