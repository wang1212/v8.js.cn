<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Top-level await · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/_css/feature-support.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="Top-level `await` is coming to JavaScript modules! You’ll soon be able to use `await` without needing to be in an async function." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li class=current><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Top-level <code>await</code></h1><p class=meta>发布时间 <time datetime="2019-10-08 00:00:00" itemprop=datePublished>2019-10-08</time> · 标签： <a href=/features/tags/ecmascript class=tag>ECMAScript</a></header><div itemprop=articleBody><p><a href=https://github.com/tc39/proposal-top-level-await>Top-level <code>await</code></a> enables developers to use the <code>await</code> keyword outside of async functions. It acts like a big async function causing other modules who <code>import</code> them to wait before they start evaluating their body.<h2 id=old>The old behavior <a href=#old class=bookmark>#</a></h2><p>When <code>async</code>/<code>await</code> was first introduced, attempting to use an <code>await</code> outside of an <code>async</code> function resulted in a <code>SyntaxError</code>. Many developers utilized immediately-invoked async function expressions as a way to get access to the feature.<pre class=language-js><code class=language-js><span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'🎉'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → SyntaxError: await is only valid in async function</span><br><br><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'🎉'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// → 🎉</span><br><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id=new>The new behavior <a href=#new class=bookmark>#</a></h2><p>With top-level <code>await</code>, the above code instead works the way you’d expect within <a href=/features/modules>modules</a>:<pre class=language-js><code class=language-js><span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'🎉'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → 🎉</span></code></pre><div class=note><p><strong>Note:</strong> Top-level <code>await</code> <em>only</em> works at the top level of modules. There is no support for classic scripts or non-async functions.</div><h2 id=use-cases>Use cases <a href=#use-cases class=bookmark>#</a></h2><p>These use cases are borrowed from the <a href=https://github.com/tc39/proposal-top-level-await#use-cases>spec proposal repository</a>.<h3 id=dynamic-dependency-pathing>Dynamic dependency pathing <a href=#dynamic-dependency-pathing class=bookmark>#</a></h3><pre class=language-js><code class=language-js><span class="token keyword">const</span> strings <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string">/i18n/</span><span class="token interpolation"><span class="token punctuation interpolation-punctuation">${</span>navigator<span class="token punctuation">.</span>language<span class="token punctuation interpolation-punctuation">}</span></span><span class="token string template-punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This allows for modules to use runtime values in order to determine dependencies. This is useful for things like development/production splits, internationalization, environment splits, etc.<h3 id=resource-initialization>Resource initialization <a href=#resource-initialization class=bookmark>#</a></h3><pre class=language-js><code class=language-js><span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">dbConnector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This allows modules to represent resources and also to produce errors in cases where the module cannot be used.<h3 id=dependency-fallbacks>Dependency fallbacks <a href=#dependency-fallbacks class=bookmark>#</a></h3><p>The following example attempts to load a JavaScript library from CDN A, falling back to CDN B if that fails:<pre class=language-js><code class=language-js><span class="token keyword">let</span> jQuery<span class="token punctuation">;</span><br><span class="token keyword">try</span> <span class="token punctuation">{</span><br>  jQuery <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'https://cdn-a.example.com/jQuery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><br>  jQuery <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'https://cdn-b.example.com/jQuery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2 id=module-execution-order>Module execution order <a href=#module-execution-order class=bookmark>#</a></h2><p>One of the biggest changes to JavaScript with top-level <code>await</code> is the order of execution of modules in your graph. The JavaScript engine executes modules in <a href=https://en.wikibooks.org/wiki/A-level_Computing/AQA/Paper_1/Fundamentals_of_algorithms/Tree_traversal#Post-order>post-order traversal</a>: starting from the left-most subtree of your module graph, modules are evaluated, their bindings are exported, and their siblings are executed, followed by their parents. This algorithm runs recursively until it executes the root of your module graph.<p>Prior to top-level <code>await</code>, this order was always synchronous and deterministic: between multiple runs of your code your graph was guaranteed to execute in the same order. Once top-level <code>await</code> lands, the same guarantee exists, but only as long as you don’t use top-level <code>await</code>.<p>Here’s what happens when you use top-level <code>await</code> in a module:<ol><li>The execution of the current module is deferred until the awaited promise is resolved.<li>The execution of the parent module is deferred until the child module that called <code>await</code>, and all its siblings, export bindings.<li>The sibling modules, and siblings of parent modules, are able to continue executing in the same synchronous order — assuming there are no cycles or other <code>await</code>ed promises in the graph.<li>The module that called <code>await</code> resumes its execution after the <code>await</code>ed promise resolves.<li>The parent module and subsequent trees continue to execute in a synchronous order as long as there are no other <code>await</code>ed promises.</ol><h2 id=doesn%E2%80%99t-this-already-work-in-devtools%3F>Doesn’t this already work in DevTools? <a href=#doesn%E2%80%99t-this-already-work-in-devtools%3F class=bookmark>#</a></h2><p>Indeed it does! The REPL in <a href=https://developers.google.com/web/updates/2017/08/devtools-release-notes#await>Chrome DevTools</a>, <a href=https://github.com/nodejs/node/issues/13209>Node.js</a>, and Safari Web Inspector have supported top-level <code>await</code> for a while now. However, this functionality was non-standard and limited to the REPL! It’s distinct from the top-level <code>await</code> proposal, which is part of the language specification and only applies to modules. To test production code relying on top-level <code>await</code> in a way that fully matches the spec proposal’s semantics, make sure to test in your actual app, and not just in DevTools or the Node.js REPL!<h2 id=isn%E2%80%99t-top-level-await-a-footgun%3F>Isn’t top-level <code>await</code> a footgun? <a href=#isn%E2%80%99t-top-level-await-a-footgun%3F class=bookmark>#</a></h2><p>Perhaps you have seen <a href=https://gist.github.com/Rich-Harris/0b6f317657f5167663b493c722647221>the infamous gist</a> by <a href=https://twitter.com/Rich_Harris>Rich Harris</a> which initially outlined a number of concerns about top-level <code>await</code> and urged the JavaScript language not to implement the feature. Some specific concerns were:<ul><li>Top-level <code>await</code> could block execution.<li>Top-level <code>await</code> could block fetching resources.<li>There would be no clear interop story for CommonJS modules.</ul><p>The stage 3 version of the proposal directly addresses these issues:<ul><li>As siblings are able to execute, there is no definitive blocking.<li>Top-level <code>await</code> occurs during the execution phase of the module graph. At this point all resources have already been fetched and linked. There is no risk of blocking fetching resources.<li>Top-level <code>await</code> is limited to modules. There is explicitly no support for scripts or for CommonJS modules.</ul><p>As with any new language feature, there’s always a risk of unexpected behavior. For example, with top-level <code>await</code>, circular module dependencies could introduce a deadlock.<p>Without top-level <code>await</code>, JavaScript developers often used async immediately-invoked function expressions just to get access to <code>await</code>. Unfortunately, this pattern results in less determinism of graph execution and static analyzability of applications. For these reasons, the lack of top-level <code>await</code> was viewed as a higher risk than the hazards introduced with the feature.<h2 id=support>Support for top-level <code>await</code> <a href=#support class=bookmark>#</a></h2><ul class=feature-support><li class="environment has-link has-support"><a href="https://bugs.chromium.org/p/v8/issues/detail?id=9344"><span class="icon chrome">Chrome:</span> <span class=support>自 <span class=version>89</span> 版本开始支持</span></a><li class="environment has-link no-support"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1519100"><span class="icon firefox">Firefox:</span> <span class=support>不支持</span></a><li class="environment has-link no-support"><a href="https://bugs.webkit.org/show_bug.cgi?id=202484"><span class="icon safari">Safari:</span> <span class=support>不支持</span></a><li class="environment no-support"><span class="icon nodejs">Node.js:</span> <span class=support>不支持</span><li class="environment has-link no-support"><a href=https://github.com/babel/proposals/issues/44><span class="icon babel">Babel:</span> <span class=support>不支持</span></a></ul><div class=feature-support-info><a href=/features/support>关于特性支持列表</a></div></div><footer><div><picture><source srcset="/_img/avatars/myles-borins.avif, /_img/avatars/myles-borins@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/myles-borins.jpg srcset="/_img/avatars/myles-borins@2x.jpg 2x" width=96></picture><p>作者：Myles Borins (<a href=https://twitter.com/MylesBorins>@MylesBorins</a>).</div><a href=https://twitter.com/v8js/status/1181581262399643650 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/features/top-level-await>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/features/top-level-await.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>