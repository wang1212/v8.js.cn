<!doctype html><html lang=zh-CN><meta charset=utf-8><title>WebAssembly integration with JavaScript BigInt ¬∑ V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/_css/feature-support.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="BigInts make it easy to pass 64-bit integers between JavaScript and WebAssembly. This post explains what that means and why it‚Äôs useful, which includes making things simpler for developers, letting code run more quickly, and also speeding up build times." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>ÊòæÁ§∫ÂØºËÇÆ</a><nav><ul><li><a href=/ >‰∏ªÈ°µ</a><li><a href=/blog/ >ÂçöÂÆ¢</a><li><a href=/docs/ >ÊñáÊ°£</a><li class=current><a href=/features title="JavaScript Âíå WebAssembly ÁöÑÊñ∞ÁâπÊÄß">JS/Wasm Êñ∞ÁâπÊÄß</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>WebAssembly integration with JavaScript BigInt</h1><p class=meta>ÂèëÂ∏ÉÊó∂Èó¥ <time datetime="2020-11-12 00:00:00" itemprop=datePublished>2020-11-12</time> ¬∑ Ê†áÁ≠æÔºö <a href=/features/tags/webassembly class=tag>WebAssembly</a> <a href=/features/tags/ecmascript class=tag>ECMAScript</a></header><div itemprop=articleBody><p>The <a href=https://github.com/WebAssembly/JS-BigInt-integration>JS-BigInt-Integration</a> feature makes it easy to pass 64-bit integers between JavaScript and WebAssembly. This post explains what that means and why it‚Äôs useful, which includes making things simpler for developers, letting code run more quickly, and also speeding up build times.<h2 id=64-bit-integers>64-bit integers <a href=#64-bit-integers class=bookmark>#</a></h2><p>JavaScript Numbers are doubles, that is, 64-bit floating-point values. Such a value can contain any 32-bit integer with full precision, but not all 64-bit ones. WebAssembly, on the other hand, has full support for 64-bit integers, the <code>i64</code> type. A problem occurs when connecting the two: If a Wasm function returns an i64, for example, then the VM throws an exception if you call it from JavaScript, something like this:<pre><code>TypeError: Wasm function signature contains illegal type
</code></pre><p>As the error says, <code>i64</code> is not a legal type for JavaScript.<p>Historically, the best solution for this was ‚Äúlegalization‚Äù of the Wasm. Legalization means to convert Wasm imports and exports to use valid types for JavaScript. In practice, that did two things:<ol><li>Replace a 64-bit integer parameter with two 32-bit ones, representing the low and high bits, respectively.<li>Replace a 64-bit integer return value with a 32-bit one representing the low bits, and use a 32-bit value on the side for the high bits.</ol><p>For example, consider this Wasm module:<pre class=language-wasm><code class=language-wasm><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$send_i64</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x</span> <span class="token keyword">i64</span><span class="token punctuation">)</span><br>    ..<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>Legalization would turn that into this:<pre class=language-wasm><code class=language-wasm><span class="token punctuation">(</span><span class="token keyword">module</span><br>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$send_i64</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x_low</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$x_high</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><br>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$x</span> <span class="token keyword">i64</span><span class="token punctuation">)</span> <span class="token comment">;; the real value the rest of the code will use</span><br>    <span class="token comment">;; code to combine $x_low and $x_high into $x</span><br>    ..<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>Legalization is done on the tools side, before it reaches the VM that runs it. For example, the <a href=https://github.com/WebAssembly/binaryen>Binaryen</a> toolchain library has a pass called <a href=https://github.com/WebAssembly/binaryen/blob/fd7e53fe0ae99bd27179cb35d537e4ce5ec1fe11/src/passes/LegalizeJSInterface.cpp>LegalizeJSInterface</a> that does that transformation, which is run automatically in <a href=https://emscripten.org/ >Emscripten</a> when it is needed.<h2 id=downsides-of-legalization>Downsides of legalization <a href=#downsides-of-legalization class=bookmark>#</a></h2><p>Legalization works well enough for many things, but it does have downsides, like the extra work to combine or split up 32-bit pieces into 64-bit values. While it‚Äôs rare that that happens on a hot path, when it does the slowdown can be noticeable - we‚Äôll see some numbers later.<p>Another annoyance is that legalization is noticeable by users, since it changes the interface between JavaScript and Wasm. Here is an example:<pre class=language-c><code class=language-c><span class="token comment">// example.c</span><br><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;stdint.h></span></span><br><br><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">send_i64_to_js</span><span class="token punctuation">(</span><span class="token class-name">int64_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">send_i64_to_js</span><span class="token punctuation">(</span><span class="token number">0xABCD12345678ULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><pre class=language-javascript><code class=language-javascript><span class="token comment">// example.js</span><br><br><span class="token function">mergeInto</span><span class="token punctuation">(</span>LibraryManager<span class="token punctuation">.</span>library<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  <span class="token function function-variable">send_i64_to_js</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"JS received: 0x"</span> <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This is a tiny C program that calls a <a href=https://emscripten.org/docs/porting/connecting_cpp_and_javascript/Interacting-with-code.html#implement-c-in-javascript>JavaScript library</a> function (that is, we define an extern C function in C, and implement it in JavaScript, as a simple and low-level way to call between Wasm and JavaScript). All this program does is send an <code>i64</code> out to JavaScript, where we attempt to print it.<p>We can build that with<pre><code>emcc example.c --js-library example.js -o out.js
</code></pre><p>When we run it, we don‚Äôt get what we expect:<pre><code>node out.js
JS received: 0x12345678
</code></pre><p>We sent <code>0xABCD12345678</code> but we only received <code>0x12345678</code> üòî. What happens here is that legalization turns that <code>i64</code> into two <code>i32</code>s, and our code just received the low 32 bits, and ignored another parameter that was sent. To handle things properly, we‚Äôd need to do something like this:<pre class=language-javascript><code class=language-javascript>  <span class="token comment">// The i64 is split into two 32-bit parameters, ‚Äúlow‚Äù and ‚Äúhigh‚Äù.</span><br>  <span class="token function function-variable">send_i64_to_js</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">low<span class="token punctuation">,</span> high</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"JS received: 0x"</span> <span class="token operator">+</span> high<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> low<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span></code></pre><p>Running this now, we get<pre><code>JS received: 0xabcd12345678
</code></pre><p>As you can see, it‚Äôs possible to live with legalization. But it can be kind of annoying!<h2 id=the-solution%3A-javascript-bigints>The solution: JavaScript BigInts <a href=#the-solution%3A-javascript-bigints class=bookmark>#</a></h2><p>JavaScript has <a href=/features/bigint>BigInt</a> values now, which represent integers of arbitrary size, so they can represent 64-bit integers properly. It is natural to want to use those to represent <code>i64</code>s from Wasm. That‚Äôs exactly what the JS-BigInt-Integration feature does!<p>Emscripten has support for Wasm BigInt integration, which we can use to compile the original example (without any hacks for legalization), by just adding <code>-s WASM_BIGINT</code>:<pre><code>emcc example.c --js-library example.js -o out.js -s WASM_BIGINT
</code></pre><p>We can then run it (note that we need to pass Node.js a flag to enable BigInt integration currently):<pre><code>node --experimental-wasm-bigint a.out.js
JS received: 0xabcd12345678
</code></pre><p>Perfect, exactly what we wanted!<p>And not only is this simpler, but it‚Äôs faster. As mentioned earlier, in practice it‚Äôs rare that <code>i64</code> conversions happen on a hot path, but when it does the slowdown can be noticeable. If we turn the above example into a benchmark, running many calls of <code>send_i64_to_js</code>, then the BigInt version is 18% faster.<p>Another benefit from BigInt integration is that the toolchain can avoid legalization. If Emscripten does not need to legalize then it may not have any work to do on the Wasm that LLVM emits, which speeds up build times. You can get that speedup if you build with <code>-s WASM_BIGINT</code> and do not provide any other flags that require changes to be made. For example, <code>-O0 -s WASM_BIGINT</code> works (but optimized builds <a href=https://emscripten.org/docs/optimizing/Optimizing-Code.html#link-times>run the Binaryen optimizer</a> which is important for size).<h2 id=conclusion>Conclusion <a href=#conclusion class=bookmark>#</a></h2><p>WebAssembly BigInt integration has been implemented in <a href=https://webassembly.org/roadmap/ >multiple browsers</a>, including Chrome 85 (released 2020-08-25) so you can try it out today!</div><footer><div><picture><source srcset="/_img/avatars/alon-zakai.avif, /_img/avatars/alon-zakai@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/alon-zakai.jpg srcset="/_img/avatars/alon-zakai@2x.jpg 2x" width=96></picture><p>‰ΩúËÄÖÔºöAlon Zakai.</div><a href=https://twitter.com/v8js/status/1331966281571037186 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/features/wasm-bigint>ÂéüÊñá</a> ¬∑ <a href=/logo/ >ÂïÜÊ†á</a> ¬∑ <a href=/terms/ >Êù°Ê¨æ</a> ¬∑ <a href=https://policies.google.com/privacy/ >ÈöêÁßÅ</a> ¬∑ <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> ¬∑ <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/features/wasm-bigint.md rel=nofollow>Âú® GitHub ÁºñËæëÊ≠§È°µÈù¢</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>Â¶ÇÊó†ÁâπÊÆäËØ¥ÊòéÔºåÊ≠§ V8 È°πÁõÆ‰∏≠‰ΩøÁî®Âà∞ÁöÑÊâÄÊúâÁ§∫‰æã‰ª£Á†ÅÂùáÂü∫‰∫é <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> ÂèëÂ∏É„ÄÇÈ°µÈù¢‰∏≠ÁöÑÊñáÂ≠óÂÜÖÂÆπÈááÁî® <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> ËøõË°åËÆ∏ÂèØ„ÄÇÊõ¥ËØ¶ÁªÜÁöÑ‰ø°ÊÅØÂèØ‰ª•Âú® <a href=/terms#site-policies>Á´ôÁÇπÁ≠ñÁï•</a> ‰∏≠ÊâæÂà∞„ÄÇ</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>