<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Promise combinators · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/_css/feature-support.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="There are four promise combinators in JavaScript: Promise.all, Promise.race, Promise.allSettled, and Promise.any." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li class=current><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Promise combinators</h1><p class=meta>发布时间 <time datetime="2019-06-12 00:00:00" itemprop=datePublished>2019-06-12</time> · 标签： <a href=/features/tags/ecmascript class=tag>ECMAScript</a> <a href=/features/tags/es2020 class=tag>ES2020</a> <a href=/features/tags/es2021 class=tag>ES2021</a></header><div itemprop=articleBody><p>Since the introduction of promises in ES2015, JavaScript has supported exactly two promise combinators: the static methods <code>Promise.all</code> and <code>Promise.race</code>.<p>Two new proposals are currently making their way through the standardization process: <code>Promise.allSettled</code>, and <code>Promise.any</code>. With those additions, there’ll be a total of four promise combinators in JavaScript, each enabling different use cases.<p>Here’s an overview of the four combinators:<div class=table-wrapper><table><thead><tr><th>name<th>description<th>status<tbody><tr><td><a href=#promise.allsettled><code>Promise.allSettled</code></a><td>does not short-circuit<td><a href=https://github.com/tc39/proposal-promise-allSettled>added in ES2020 ✅</a><tr><td><a href=#promise.all><code>Promise.all</code></a><td>short-circuits when an input value is rejected<td>added in ES2015 ✅<tr><td><a href=#promise.race><code>Promise.race</code></a><td>short-circuits when an input value is settled<td>added in ES2015 ✅<tr><td><a href=#promise.any><code>Promise.any</code></a><td>short-circuits when an input value is fulfilled<td><a href=https://github.com/tc39/proposal-promise-any>added in ES2021 ✅</a></table></div><p>Let’s take a look at an example use case for each combinator.<h2 id=promise.all><code>Promise.all</code> <a href=#promise.all class=bookmark>#</a></h2><ul class=feature-support><li class="environment has-support"><span class="icon chrome">Chrome:</span> <span class=support>自 <span class=version>32</span> 版本开始支持</span><li class="environment has-support"><span class="icon firefox">Firefox:</span> <span class=support>自 <span class=version>29</span> 版本开始支持</span><li class="environment has-support"><span class="icon safari">Safari:</span> <span class=support>自 <span class=version>8</span> 版本开始支持</span><li class="environment has-support"><span class="icon nodejs">Node.js:</span> <span class=support>自 <span class=version>0.12</span> 版本开始支持</span><li class="environment has-support"><span class="icon babel">Babel:</span> <span class=support>支持</span></ul><div class=feature-support-info><a href=/features/support>关于特性支持列表</a></div><p><code>Promise.all</code> lets you know when either all input promises have fulfilled or when one of them rejects.<p>Imagine the user clicks a button and you want to load some stylesheets so you can render a completely new UI. This program kicks off an HTTP request for each stylesheet in parallel:<pre class=language-js><code class=language-js><span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/component-a.css'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/component-b.css'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/component-c.css'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">try</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> styleResponses <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">enableStyles</span><span class="token punctuation">(</span>styleResponses<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">renderNewUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">displayError</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>You only want to start rendering the new UI once <em>all</em> requests succeeded. If something goes wrong, you want to instead display an error message as soon as possible, without waiting for other any other work to finish.<p>In such a case, you could use <code>Promise.all</code>: you want to know when all promises are fulfilled, <em>or</em> as soon as one of them rejects.<h2 id=promise.race><code>Promise.race</code> <a href=#promise.race class=bookmark>#</a></h2><ul class=feature-support><li class="environment has-support"><span class="icon chrome">Chrome:</span> <span class=support>自 <span class=version>32</span> 版本开始支持</span><li class="environment has-support"><span class="icon firefox">Firefox:</span> <span class=support>自 <span class=version>29</span> 版本开始支持</span><li class="environment has-support"><span class="icon safari">Safari:</span> <span class=support>自 <span class=version>8</span> 版本开始支持</span><li class="environment has-support"><span class="icon nodejs">Node.js:</span> <span class=support>自 <span class=version>0.12</span> 版本开始支持</span><li class="environment has-support"><span class="icon babel">Babel:</span> <span class=support>支持</span></ul><div class=feature-support-info><a href=/features/support>关于特性支持列表</a></div><p><code>Promise.race</code> is useful if you want to run multiple promises, and either…<ol><li>do something with the first successful result that comes in (in case one of the promises fulfills), <em>or</em><li>do something as soon as one of the promises rejects.</ol><p>That is, if one of the promises rejects, you want to preserve that rejection to treat the error case separately. The following example does exactly that:<pre class=language-js><code class=language-js><span class="token keyword">try</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><br>    <span class="token function">performHeavyComputation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">rejectAfterTimeout</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">renderResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">renderError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>We kick off a computationally expensive task that might take a long time, but we race it against a promise that rejects after 2 seconds. Depending on the first promise to fulfill or reject, we either render the computed result, or the error message, in two separate code paths.<h2 id=promise.allsettled><code>Promise.allSettled</code> <a href=#promise.allsettled class=bookmark>#</a></h2><ul class=feature-support><li class="environment has-support"><span class="icon chrome">Chrome:</span> <span class=support>自 <span class=version>76</span> 版本开始支持</span><li class="environment has-support has-link"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1549176"><span class="icon firefox">Firefox:</span> <span class=support>自 <span class=version>71</span> 版本开始支持</span></a><li class="environment has-support"><span class="icon safari">Safari:</span> <span class=support>自 <span class=version>13</span> 版本开始支持</span><li class="environment has-support has-link"><a href=https://nodejs.org/en/blog/release/v12.9.0/ ><span class="icon nodejs">Node.js:</span> <span class=support>自 <span class=version>12.9.0</span> 版本开始支持</span></a><li class="environment has-support"><span class="icon babel">Babel:</span> <span class=support>支持</span></ul><div class=feature-support-info><a href=/features/support>关于特性支持列表</a></div><p><code>Promise.allSettled</code> gives you a signal when all the input promises are <em>settled</em>, which means they’re either <em>fulfilled</em> or <em>rejected</em>. This is useful in cases where you don’t care about the state of the promise, you just want to know when the work is done, regardless of whether it was successful.<p>For example, you can kick off a series of independent API calls and use <code>Promise.allSettled</code> to make sure they’re all completed before doing something else, like removing a loading spinner:<pre class=language-js><code class=language-js><span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api-call-1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api-call-2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api-call-3'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token comment">// Imagine some of these requests fail, and some succeed.</span><br><br><span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">allSettled</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// All API calls have finished (either failed or succeeded).</span><br><span class="token function">removeLoadingIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id=promise.any><code>Promise.any</code> <a href=#promise.any class=bookmark>#</a></h2><ul class=feature-support><li class="environment has-support has-link"><a href="https://bugs.chromium.org/p/v8/issues/detail?id=9808"><span class="icon chrome">Chrome:</span> <span class=support>自 <span class=version>85</span> 版本开始支持</span></a><li class="environment has-support has-link"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1568903"><span class="icon firefox">Firefox:</span> <span class=support>自 <span class=version>79</span> 版本开始支持</span></a><li class="environment has-support has-link"><a href="https://bugs.webkit.org/show_bug.cgi?id=202566"><span class="icon safari">Safari:</span> <span class=support>自 <span class=version>14</span> 版本开始支持</span></a><li class="environment no-support"><span class="icon nodejs">Node.js:</span> <span class=support>不支持</span><li class="environment has-support"><span class="icon babel">Babel:</span> <span class=support>支持</span></ul><div class=feature-support-info><a href=/features/support>关于特性支持列表</a></div><p><code>Promise.any</code> gives you a signal as soon as one of the promises fulfills. This is similar to <code>Promise.race</code>, except <code>any</code> doesn’t reject early when one of the promises rejects.<pre class=language-js><code class=language-js><span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/endpoint-a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/endpoint-b'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/endpoint-c'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">try</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> first <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Any of the promises was fulfilled.</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// → e.g. 'b'</span><br><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// All of the promises were rejected.</span><br>  console<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">AggregateError</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Log the rejection values:</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// → [</span><br>  <span class="token comment">//     &lt;TypeError: Failed to fetch /endpoint-a>,</span><br>  <span class="token comment">//     &lt;TypeError: Failed to fetch /endpoint-b>,</span><br>  <span class="token comment">//     &lt;TypeError: Failed to fetch /endpoint-c></span><br>  <span class="token comment">//   ]</span><br><span class="token punctuation">}</span></code></pre><p>This code example checks which endpoint responds the fastest, and then logs it. Only if <em>all</em> of the requests fail do we end up in the <code>catch</code> block, where we can then handle the errors.<p><code>Promise.any</code> rejections can represent multiple errors at once. To support this at the language-level, a new error type called <code>AggregateError</code> is introduced. In addition to its basic usage in the above example, <code>AggregateError</code> objects can also be programmatically constructed, just like the other error types:<pre class=language-js><code class=language-js><span class="token keyword">const</span> aggregateError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AggregateError</span><span class="token punctuation">(</span><span class="token punctuation">[</span>errorA<span class="token punctuation">,</span> errorB<span class="token punctuation">,</span> errorC<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'Stuff went wrong!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><footer><div><picture><source srcset="/_img/avatars/mathias-bynens.avif, /_img/avatars/mathias-bynens@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/mathias-bynens.jpg srcset="/_img/avatars/mathias-bynens@2x.jpg 2x" width=96></picture><p>作者：Mathias Bynens (<a href=https://twitter.com/mathias>@mathias</a>).</div><a href=https://twitter.com/v8js/status/1138819493956710400 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/features/promise-combinators>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/features/promise-combinators.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>