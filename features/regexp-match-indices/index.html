<!doctype html><html lang=zh-CN><meta charset=utf-8><title>RegExp match indices · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/_css/feature-support.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="RegExp match indices provide `start` and `end` indices of each matched capture group." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li class=current><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>RegExp match indices</h1><p class=meta>发布时间 <time datetime="2019-12-17 00:00:00" itemprop=datePublished>2019-12-17</time> · 标签： <a href=/features/tags/ecmascript class=tag>ECMAScript</a></header><div itemprop=articleBody><p>JavaScript is now equipped with a new regular expression enhancement, called “match indices”. Imagine you want to find invalid variable names in JavaScript code that coincide with reserved words, and output a caret and an “underline” under the variable name, like:<pre class=language-js><code class=language-js><span class="token keyword">const</span> <span class="token keyword">function</span> <span class="token operator">=</span> foo<span class="token punctuation">;</span><br>      <span class="token operator">^</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> Invalid variable name</code></pre><p>In the example above, <code>function</code> is a reserved word and cannot be used as a variable name. For that we might write the following function:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">displayError</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token operator">/</span>\<span class="token function">b</span><span class="token punctuation">(</span><span class="token keyword">continue</span><span class="token operator">|</span><span class="token keyword">function</span><span class="token operator">|</span><span class="token keyword">break</span><span class="token operator">|</span><span class="token keyword">for</span><span class="token operator">|</span><span class="token keyword">if</span><span class="token punctuation">)</span>\b<span class="token operator">/</span>d<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> match <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Index `1` corresponds to the first capture group.</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>start<span class="token punctuation">,</span> end<span class="token punctuation">]</span> <span class="token operator">=</span> match<span class="token punctuation">.</span>indices<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token comment">// Adjust the caret position.</span><br>    <span class="token string">'^'</span> <span class="token operator">+</span><br>    <span class="token string">'-'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span>   <span class="token comment">// Append the underline.</span><br>    <span class="token string">' '</span> <span class="token operator">+</span> message<span class="token punctuation">;</span>                  <span class="token comment">// Append the message.</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token string">'const function = foo;'</span><span class="token punctuation">;</span> <span class="token comment">// faulty code</span><br><span class="token function">displayError</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">'Invalid variable name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><div class=note><p><strong>Note:</strong> For simplicity, the above example contains only a few of the JavaScript <a href=https://mathiasbynens.be/notes/reserved-keywords>reserved words</a>.</div><p>In short, the new <code>indices</code> array stores the start and end positions of each matched capture group. This new array is available when the source regular expression uses the <code>/d</code> flag for all builtins producing regular expression match objects, including <code>RegExp#exec</code>, <code>String#match</code>, and <a href=https://v8.dev/features/string-matchall><code>String#matchAll</code></a>.<p>Read on if you’re interested in how it works in more detail.<h2 id=motivation>Motivation <a href=#motivation class=bookmark>#</a></h2><p>Let’s move to a more involved example and think about how you’d solve the task of parsing a programming language (for instance what the <a href=https://github.com/microsoft/TypeScript/tree/master/src/compiler>TypeScript compiler</a> does) — first split the input source code into tokens, then give a syntactic structure to those tokens. If the user wrote some syntactically incorrect code, you’d want to present them with a meaningful error, ideally pointing to the location where the problematic code was first encountered. For example, given the following code snippet:<pre class=language-js><code class=language-js><span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><br><span class="token comment">// some other code</span><br><span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token number">1337</span><span class="token punctuation">;</span></code></pre><p>We’d want to present the programmer with an error like:<pre class=language-js><code class=language-js><span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token number">1337</span><span class="token punctuation">;</span><br>    <span class="token operator">^</span><br>SyntaxError<span class="token operator">:</span> Identifier <span class="token string">'foo'</span> has already been declared</code></pre><p>To achieve this, we need a few building blocks, the first of which is recognizing TypeScript identifiers. Then we’ll focus on pinpointing the exact location where the error occurred. Let’s consider the following example, using a regex to tell whether a string is a valid identifier:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">isIdentifier</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token language-regex regex-source">^[a-zA-Z_$][0-9a-zA-Z_$]*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><div class=note><p><strong>Note:</strong> A real-world parser could make use of the newly introduced <a href=https://github.com/tc39/proposal-regexp-unicode-property-escapes#other-examples>property escapes in regexes</a> and use the following regular expression for matching all valid ECMAScript identifier names:<pre class=language-js><code class=language-js><span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token language-regex regex-source">^[$_\p{ID_Start}][$_\u200C\u200D\p{ID_Continue}]*$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">u</span></span><span class="token punctuation">;</span></code></pre><p>For simplicity, let’s stick to our previous regex, which matches only Latin characters, numbers, and underscores.</div><p>If we encounter an error with a variable declaration like above and want to print the exact position to the user, we might want to extend the regex from above and use a similar function:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">getDeclarationPosition</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token language-regex regex-source">(let|const|var)\s+([a-zA-Z_$][0-9a-zA-Z_$]*)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> match <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> match<span class="token punctuation">.</span>index<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>One could use the <code>index</code> property on the match object returned by <code>RegExp.prototype.exec</code>, which returns the starting position of the whole match. For use cases like the one described above though, you’d often want to use (possibly multiple) capture groups. Until recently, JavaScript didn’t expose the indices where the substrings matched by capture groups begin and end.<h2 id=regexp-match-indices-explained>RegExp match indices explained <a href=#regexp-match-indices-explained class=bookmark>#</a></h2><p>Ideally we want to print an error at the position of the variable name, not at the <code>let</code>/<code>const</code> keyword (as the example above does). But for that we’d need to find the position of the capture group with index <code>2</code>. (Index <code>1</code> refers to the <code>(let|const|var)</code> capture group and <code>0</code> refers to the entire match.)<p>As mentioned above, <a href=https://github.com/tc39/proposal-regexp-match-indices>the new JavaScript feature</a> adds an <code>indices</code> property on the result (the array of substrings) of <code>RegExp.prototype.exec()</code>. Let’s enhance our example from above to make use of this new property:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">getVariablePosition</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Notice the `d` flag, which enables `match.indices`</span><br>  <span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token operator">|</span><span class="token keyword">const</span><span class="token operator">|</span><span class="token keyword">var</span><span class="token punctuation">)</span>\s<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token operator">-</span>zA<span class="token operator">-</span><span class="token constant">Z_</span>$<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">9</span>a<span class="token operator">-</span>zA<span class="token operator">-</span><span class="token constant">Z_</span>$<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">/</span>d<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> match <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> match<span class="token punctuation">.</span>indices<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token function">getVariablePosition</span><span class="token punctuation">(</span><span class="token string">'let foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → [4, 7]</span></code></pre><p>This example returns the array <code>[4, 7]</code>, which is the <code>[start, end)</code> position of the matched substring from the group with index <code>2</code>. Based on this information, our compiler can now print the desired error.<h2 id=additional-features>Additional features <a href=#additional-features class=bookmark>#</a></h2><p>The <code>indices</code> object also contains a <code>groups</code> property, which can be indexed by the names of the <a href=https://mathiasbynens.be/notes/es-regexp-proposals#named-capture-groups>named capture groups</a>. Using that, the function from above can be rewritten as:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">getVariablePosition</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token operator">/</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token operator">&lt;</span>keyword<span class="token operator">></span><span class="token keyword">let</span><span class="token operator">|</span><span class="token keyword">const</span><span class="token operator">|</span><span class="token keyword">var</span><span class="token punctuation">)</span>\s<span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token operator">&lt;</span>id<span class="token operator">></span><span class="token punctuation">[</span>a<span class="token operator">-</span>zA<span class="token operator">-</span><span class="token constant">Z_</span>$<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">9</span>a<span class="token operator">-</span>zA<span class="token operator">-</span><span class="token constant">Z_</span>$<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">/</span>d<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> match <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> match<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>groups<span class="token punctuation">.</span>id<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token function">getVariablePosition</span><span class="token punctuation">(</span><span class="token string">'let foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id=support-for-regexp-match-indices>Support for RegExp match indices <a href=#support-for-regexp-match-indices class=bookmark>#</a></h2><ul class=feature-support><li class="environment has-link has-support"><a href="https://bugs.chromium.org/p/v8/issues/detail?id=9548"><span class="icon chrome">Chrome:</span> <span class=support>自 <span class=version>90</span> 版本开始支持</span></a><li class="environment no-support has-link"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1519483"><span class="icon firefox">Firefox:</span> <span class=support>不支持</span></a><li class="environment no-support has-link"><a href="https://bugs.webkit.org/show_bug.cgi?id=202475"><span class="icon safari">Safari:</span> <span class=support>不支持</span></a><li class="environment no-support"><span class="icon nodejs">Node.js:</span> <span class=support>不支持</span><li class="environment no-support"><span class="icon babel">Babel:</span> <span class=support>不支持</span></ul><div class=feature-support-info><a href=/features/support>关于特性支持列表</a></div></div><footer><div><picture><source srcset="/_img/avatars/maya-armyanova.avif, /_img/avatars/maya-armyanova@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/maya-armyanova.jpg srcset="/_img/avatars/maya-armyanova@2x.jpg 2x" width=96></picture><p>作者：Maya Armyanova (<a href=https://twitter.com/Zmayski>@Zmayski</a>), regularly expressing new features.</div><a href=https://twitter.com/v8js/status/1206970814400270338 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/features/regexp-match-indices>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/features/regexp-match-indices.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>