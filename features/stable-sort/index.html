<!doctype html><html lang=zh-CN><meta charset=utf-8><title>稳定的数组排序 Array.prototype.sort · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/_css/feature-support.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="Array.prototype.sort is now guaranteed to be stable." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li class=current><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>稳定的数组排序 <code>Array.prototype.sort</code></h1><p class=meta>发布时间 <time datetime="2019-07-02 00:00:00" itemprop=datePublished>2019-07-02</time> · 标签： <a href=/features/tags/ecmascript class=tag>ECMAScript</a> <a href=/features/tags/es2019 class=tag>ES2019</a></header><div itemprop=articleBody><p>假设你有一个存储狗的数组 <code>doggos</code>，每只狗都有一个名字和评级。（如果这个例子听起来有些奇怪，你可能不知道有一个专门针对这个的 Twitter 账户...所以，不要问！）<pre class=language-js><code class=language-js><span class="token comment">// 注意未排序的数组是按 `name` 排序的</span><br><span class="token keyword">const</span> doggos <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Abby'</span><span class="token punctuation">,</span>   rating<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Bandit'</span><span class="token punctuation">,</span> rating<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Choco'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Daisy'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Elmo'</span><span class="token punctuation">,</span>   rating<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Falco'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Ghost'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token comment">// 根据 `rating` 降序排列</span><br><span class="token comment">// (这将会更改 `doggos` 本身)</span><br>doggos<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> b<span class="token punctuation">.</span>rating <span class="token operator">-</span> a<span class="token punctuation">.</span>rating<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>数组根据名字(<code>name</code>)按字母顺序预排序。要通过评级(<code>rating</code>)来排序（这样我们就可以获得评分最高的狗），我们使用 <code>Array#sort</code>，传入一个比较评级的自定义回调函数。这是您期望的结果：<pre class=language-js><code class=language-js><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Choco'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Ghost'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Bandit'</span><span class="token punctuation">,</span> rating<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Falco'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Abby'</span><span class="token punctuation">,</span>   rating<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Daisy'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Elmo'</span><span class="token punctuation">,</span>   rating<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span></code></pre><p>狗按等级排序，但在每个评级中，它们仍然根据名字按字母顺序排序。例如，Choco 和 Ghost 具有相同的等级 14，但 Choco 在排序结果中出现在 Ghost 之前，因为这也是他们在原始数组中的顺序。<p>然而，为了得到这个结果，JavaScript 引擎不能随意使用排序算法 - 它必须是所谓的“稳定排序”。很长一段时间，JavaScript 规范 <code>Array#sort</code> 不需要排序稳定性，而是将其留给实现。而且由于这种行为未指定，你也可能会得到这种结果：Ghost 现在突然出现在 Choco 之前：<pre class=language-js><code class=language-js><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Ghost'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 😢</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Choco'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 😢</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Bandit'</span><span class="token punctuation">,</span> rating<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Falco'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Abby'</span><span class="token punctuation">,</span>   rating<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Daisy'</span><span class="token punctuation">,</span>  rating<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Elmo'</span><span class="token punctuation">,</span>   rating<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span></code></pre><p>换句话说，JavaScript 开发人员不能依赖排序稳定性。在实践中，情况更令人愤怒，因为一些 JavaScript 引擎会对短数组使用稳定排序，对较大数组使用不稳定排序。这真的令人困惑，因为开发人员会测试他们的代码，看到稳定的结果，但是当数组稍微大一点时，突然会在生产环境中获得不稳定的结果。<p>但是有一些好消息。我们提出了一个 <code>Array#sort</code> 稳定性的<a href=https://github.com/tc39/ecma262/pull/1340>规范变化</a>，它被接受了。现在所有主流的 JavaScript 引擎都实现了稳定 <code>Array#sort</code>。这是作为 JavaScript 开发人员一直担心的一件事。太帮了！<p>（哦，<a href=https://github.com/tc39/ecma262/pull/1433>我们为 <code>TypedArray</code> 做了同样的事情</a>：它们的排序现在也稳定了。）<div class=note><p><strong>注意:</strong> 虽然现在规范要求排序必须具有稳定性，但 JavaScript 引擎仍然可以自由地实现他们喜欢的任何排序算法。例如，<a href=/blog/array-sort#timsort>V8 使用 Timsort</a>。该规范并未强制要求任何特定的排序算法。</div><h2 id=support>Feature support <a href=#support class=bookmark>#</a></h2><h3 id=support-stable-array-sort>Stable <code>Array.prototype.sort</code> <a href=#support-stable-array-sort class=bookmark>#</a></h3><ul class=feature-support><li class="environment has-support has-link"><a href=/blog/v8-release-70#javascript-language-features><span class="icon chrome">Chrome:</span> <span class=support>自 <span class=version>70</span> 版本开始支持</span></a><li class="environment has-support"><span class="icon firefox">Firefox:</span> <span class=support>支持</span><li class="environment has-support"><span class="icon safari">Safari:</span> <span class=support>支持</span><li class="environment has-support has-link"><a href=https://twitter.com/mathias/status/1120700101637353473><span class="icon nodejs">Node.js:</span> <span class=support>自 <span class=version>12</span> 版本开始支持</span></a><li class="environment no-support"><span class="icon babel">Babel:</span> <span class=support>不支持</span></ul><div class=feature-support-info><a href=/features/support>关于特性支持列表</a></div><h3 id=support-stable-typedarray-sort>Stable <code>%TypedArray%.prototype.sort</code> <a href=#support-stable-typedarray-sort class=bookmark>#</a></h3><ul class=feature-support><li class="environment has-support has-link"><a href="https://bugs.chromium.org/p/v8/issues/detail?id=8567"><span class="icon chrome">Chrome:</span> <span class=support>自 <span class=version>74</span> 版本开始支持</span></a><li class="environment has-support has-link"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1290554"><span class="icon firefox">Firefox:</span> <span class=support>自 <span class=version>67</span> 版本开始支持</span></a><li class="environment has-support"><span class="icon safari">Safari:</span> <span class=support>支持</span><li class="environment has-support has-link"><a href=https://twitter.com/mathias/status/1120700101637353473><span class="icon nodejs">Node.js:</span> <span class=support>自 <span class=version>12</span> 版本开始支持</span></a><li class="environment no-support"><span class="icon babel">Babel:</span> <span class=support>不支持</span></ul><div class=feature-support-info><a href=/features/support>关于特性支持列表</a></div></div><footer><div><picture><source srcset="/_img/avatars/mathias-bynens.avif, /_img/avatars/mathias-bynens@2x.avif 2x" type=image/avif><img alt="" height=96 src=/_img/avatars/mathias-bynens.jpg srcset="/_img/avatars/mathias-bynens@2x.jpg 2x" width=96 loading=lazy></picture><p>作者：Mathias Bynens (<a href=https://twitter.com/mathias>@mathias</a>).</div><a href=https://twitter.com/v8js/status/1146067251302244353 class=retweet>Retweet this article!</a></footer><footer><div><img alt="" height=96 src=/_img/avatars/justjavac.jpg srcset="/_img/avatars/justjavac@2x.jpg 2x" width=96 lazyload=on><p>译者：迷渡 (<a href=https://github.com/justjavac>@justjavac</a>)，V8.js.cn 站长.</div></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/features/stable-sort>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/features/stable-sort.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>